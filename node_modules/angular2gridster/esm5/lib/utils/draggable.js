import { __assign } from "tslib";
import { fromEvent, merge } from 'rxjs';
import { share, map, filter, tap, switchMap, takeUntil, take, skip } from 'rxjs/operators';
import { DraggableEvent } from './DraggableEvent';
import { utils } from './utils';
var Draggable = /** @class */ (function () {
    function Draggable(element, config) {
        if (config === void 0) { config = {}; }
        this.mousemove = merge(fromEvent(document, 'mousemove'), fromEvent(document, 'touchmove', { passive: false })).pipe(share());
        this.mouseup = merge(fromEvent(document, 'mouseup'), fromEvent(document, 'touchend'), fromEvent(document, 'touchcancel')).pipe(share());
        this.config = {
            handlerClass: null,
            scroll: true,
            scrollEdge: 36,
            scrollDirection: null
        };
        // reference to auto scrolling listeners
        this.autoScrollingInterval = [];
        this.element = element;
        this.mousedown = merge(fromEvent(element, 'mousedown'), fromEvent(element, 'touchstart')).pipe(share());
        this.config = __assign(__assign({}, this.config), config);
        this.dragStart = this.createDragStartObservable().pipe(share());
        this.dragMove = this.createDragMoveObservable(this.dragStart);
        this.dragStop = this.createDragStopObservable(this.dragStart);
        this.fixProblemWithDnDForIE(element);
        this.requestAnimationFrame =
            window.requestAnimationFrame || (function (callback) { return setTimeout(callback, 1000 / 60); });
        this.cancelAnimationFrame = window.cancelAnimationFrame || (function (cafID) { return clearTimeout(cafID); });
    }
    Draggable.prototype.createDragStartObservable = function () {
        var _this = this;
        return this.mousedown.pipe(map(function (md) { return new DraggableEvent(md); }), filter(function (event) { return _this.isDragingByHandler(event); }), tap(function (e) {
            if (!e.isTouchEvent()) {
                e.pauseEvent();
            }
            if (document.activeElement) {
                document.activeElement.blur();
            }
            // prevents rendering performance issues while dragging item with selection inside
            utils.clearSelection();
        }), switchMap(function (startEvent) {
            return _this.mousemove.pipe(map(function (mm) { return new DraggableEvent(mm); }), filter(function (moveEvent) { return _this.inRange(startEvent, moveEvent, 5); }), map(function () { return startEvent; }), takeUntil(_this.mouseup), take(1));
        }));
    };
    Draggable.prototype.createDragMoveObservable = function (dragStart) {
        var _this = this;
        return dragStart.pipe(tap(function (event) {
            _this.addTouchActionNone(event.target);
        }), switchMap(function (startEvent) {
            return _this.mousemove.pipe(skip(1), map(function (mm) { return new DraggableEvent(mm); }), tap(function (event) {
                event.pauseEvent();
                startEvent.pauseEvent();
            }), takeUntil(_this.mouseup));
        }), filter(function (val) { return !!val; }), tap(function (event) {
            if (_this.config.scroll) {
                _this.startScroll(_this.element, event);
            }
        }));
    };
    Draggable.prototype.createDragStopObservable = function (dragStart) {
        var _this = this;
        return dragStart.pipe(switchMap(function () {
            return _this.mouseup.pipe(take(1));
        }), map(function (e) { return new DraggableEvent(e); }), tap(function (e) {
            if (e.target) {
                _this.removeTouchActionNone(e.target);
            }
            _this.autoScrollingInterval.forEach(function (raf) { return _this.cancelAnimationFrame(raf); });
        }));
    };
    Draggable.prototype.startScroll = function (item, event) {
        var _this = this;
        var scrollContainer = this.getScrollContainer(item);
        this.autoScrollingInterval.forEach(function (raf) { return _this.cancelAnimationFrame(raf); });
        if (scrollContainer) {
            this.startScrollForContainer(event, scrollContainer);
        }
        else {
            this.startScrollForWindow(event);
        }
    };
    Draggable.prototype.startScrollForContainer = function (event, scrollContainer) {
        if (!this.config.scrollDirection || this.config.scrollDirection === 'vertical') {
            this.startScrollVerticallyForContainer(event, scrollContainer);
        }
        if (!this.config.scrollDirection || this.config.scrollDirection === 'horizontal') {
            this.startScrollHorizontallyForContainer(event, scrollContainer);
        }
    };
    Draggable.prototype.startScrollVerticallyForContainer = function (event, scrollContainer) {
        if (event.pageY - this.getOffset(scrollContainer).top < this.config.scrollEdge) {
            this.startAutoScrolling(scrollContainer, -Draggable.SCROLL_SPEED, 'scrollTop');
        }
        else if (this.getOffset(scrollContainer).top +
            scrollContainer.getBoundingClientRect().height -
            event.pageY <
            this.config.scrollEdge) {
            this.startAutoScrolling(scrollContainer, Draggable.SCROLL_SPEED, 'scrollTop');
        }
    };
    Draggable.prototype.startScrollHorizontallyForContainer = function (event, scrollContainer) {
        if (event.pageX - scrollContainer.getBoundingClientRect().left < this.config.scrollEdge) {
            this.startAutoScrolling(scrollContainer, -Draggable.SCROLL_SPEED, 'scrollLeft');
        }
        else if (this.getOffset(scrollContainer).left +
            scrollContainer.getBoundingClientRect().width -
            event.pageX <
            this.config.scrollEdge) {
            this.startAutoScrolling(scrollContainer, Draggable.SCROLL_SPEED, 'scrollLeft');
        }
    };
    Draggable.prototype.startScrollForWindow = function (event) {
        if (!this.config.scrollDirection || this.config.scrollDirection === 'vertical') {
            this.startScrollVerticallyForWindow(event);
        }
        if (!this.config.scrollDirection || this.config.scrollDirection === 'horizontal') {
            this.startScrollHorizontallyForWindow(event);
        }
    };
    Draggable.prototype.startScrollVerticallyForWindow = function (event) {
        var scrollingElement = document.scrollingElement || document.documentElement || document.body;
        // NOTE: Using `window.pageYOffset` here because IE doesn't have `window.scrollY`.
        if (event.pageY - window.pageYOffset < this.config.scrollEdge) {
            this.startAutoScrolling(scrollingElement, -Draggable.SCROLL_SPEED, 'scrollTop');
        }
        else if (window.innerHeight - (event.pageY - window.pageYOffset) <
            this.config.scrollEdge) {
            this.startAutoScrolling(scrollingElement, Draggable.SCROLL_SPEED, 'scrollTop');
        }
    };
    Draggable.prototype.startScrollHorizontallyForWindow = function (event) {
        var scrollingElement = document.scrollingElement || document.documentElement || document.body;
        // NOTE: Using `window.pageXOffset` here because IE doesn't have `window.scrollX`.
        if (event.pageX - window.pageXOffset < this.config.scrollEdge) {
            this.startAutoScrolling(scrollingElement, -Draggable.SCROLL_SPEED, 'scrollLeft');
        }
        else if (window.innerWidth - (event.pageX - window.pageXOffset) <
            this.config.scrollEdge) {
            this.startAutoScrolling(scrollingElement, Draggable.SCROLL_SPEED, 'scrollLeft');
        }
    };
    Draggable.prototype.getScrollContainer = function (node) {
        var nodeOuterHeight = utils.getElementOuterHeight(node);
        if (node.scrollHeight > Math.ceil(nodeOuterHeight)) {
            return node;
        }
        if (!new RegExp('(body|html)', 'i').test(node.parentNode.tagName)) {
            return this.getScrollContainer(node.parentNode);
        }
        return null;
    };
    Draggable.prototype.startAutoScrolling = function (node, amount, direction) {
        this.autoScrollingInterval.push(this.requestAnimationFrame(function () {
            this.startAutoScrolling(node, amount, direction);
        }.bind(this)));
        return (node[direction] += amount * 0.25);
    };
    Draggable.prototype.getOffset = function (el) {
        var rect = el.getBoundingClientRect();
        return {
            left: rect.left + this.getScroll('scrollLeft', 'pageXOffset'),
            top: rect.top + this.getScroll('scrollTop', 'pageYOffset')
        };
    };
    Draggable.prototype.getScroll = function (scrollProp, offsetProp) {
        if (typeof window[offsetProp] !== 'undefined') {
            return window[offsetProp];
        }
        if (document.documentElement.clientHeight) {
            return document.documentElement[scrollProp];
        }
        return document.body[scrollProp];
    };
    Draggable.prototype.isDragingByHandler = function (event) {
        if (!this.isValidDragHandler(event.target)) {
            return false;
        }
        return (!this.config.handlerClass ||
            (this.config.handlerClass &&
                this.hasElementWithClass(this.config.handlerClass, event.target)));
    };
    Draggable.prototype.isValidDragHandler = function (targetEl) {
        return ['input', 'textarea'].indexOf(targetEl.tagName.toLowerCase()) === -1;
    };
    Draggable.prototype.inRange = function (startEvent, moveEvent, range) {
        return (Math.abs(moveEvent.clientX - startEvent.clientX) > range ||
            Math.abs(moveEvent.clientY - startEvent.clientY) > range);
    };
    Draggable.prototype.hasElementWithClass = function (className, target) {
        while (target !== this.element) {
            if (target.classList.contains(className)) {
                return true;
            }
            target = target.parentElement;
        }
        return false;
    };
    Draggable.prototype.pauseEvent = function (e) {
        if (e.stopPropagation) {
            e.stopPropagation();
        }
        if (e.preventDefault) {
            e.preventDefault();
        }
        e.cancelBubble = true;
        e.returnValue = false;
    };
    Draggable.prototype.fixProblemWithDnDForIE = function (element) {
        if (this.isTouchDevice() && this.isIEorEdge() && element.style) {
            element.style['touch-action'] = 'none';
        }
    };
    Draggable.prototype.removeTouchActionNone = function (element) {
        if (!element.style) {
            return;
        }
        element.style['touch-action'] = '';
    };
    Draggable.prototype.addTouchActionNone = function (element) {
        if (!element.style) {
            return;
        }
        element.style['touch-action'] = 'none';
    };
    Draggable.prototype.isTouchDevice = function () {
        return ('ontouchstart' in window || navigator.maxTouchPoints // works on most browsers
        ); // works on IE10/11 and Surface
    };
    Draggable.prototype.isIEorEdge = function () {
        var ua = window.navigator.userAgent;
        var msie = ua.indexOf('MSIE ');
        if (msie > 0) {
            // IE 10 or older => return version number
            return parseInt(ua.substring(msie + 5, ua.indexOf('.', msie)), 10);
        }
        var trident = ua.indexOf('Trident/');
        if (trident > 0) {
            // IE 11 => return version number
            var rv = ua.indexOf('rv:');
            return parseInt(ua.substring(rv + 3, ua.indexOf('.', rv)), 10);
        }
        var edge = ua.indexOf('Edge/');
        if (edge > 0) {
            // Edge (IE 12+) => return version number
            return parseInt(ua.substring(edge + 5, ua.indexOf('.', edge)), 10);
        }
        // other browser
        return false;
    };
    Draggable.SCROLL_SPEED = 20;
    return Draggable;
}());
export { Draggable };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZHJhZ2dhYmxlLmpzIiwic291cmNlUm9vdCI6Im5nOi8vYW5ndWxhcjJncmlkc3Rlci8iLCJzb3VyY2VzIjpbImxpYi91dGlscy9kcmFnZ2FibGUudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUFBLE9BQU8sRUFBYyxTQUFTLEVBQUUsS0FBSyxFQUFRLE1BQU0sTUFBTSxDQUFDO0FBQzFELE9BQU8sRUFBRSxLQUFLLEVBQUUsR0FBRyxFQUFFLE1BQU0sRUFBRSxHQUFHLEVBQUUsU0FBUyxFQUFFLFNBQVMsRUFBRSxJQUFJLEVBQUUsSUFBSSxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFFM0YsT0FBTyxFQUFFLGNBQWMsRUFBRSxNQUFNLGtCQUFrQixDQUFDO0FBQ2xELE9BQU8sRUFBRSxLQUFLLEVBQUUsTUFBTSxTQUFTLENBQUM7QUFFaEM7SUE2QkksbUJBQVksT0FBZ0IsRUFBRSxNQUFXO1FBQVgsdUJBQUEsRUFBQSxXQUFXO1FBbkJqQyxjQUFTLEdBQTJCLEtBQUssQ0FDN0MsU0FBUyxDQUFDLFFBQVEsRUFBRSxXQUFXLENBQUMsRUFDaEMsU0FBUyxDQUFDLFFBQVEsRUFBRSxXQUFXLEVBQUUsRUFBRSxPQUFPLEVBQUUsS0FBSyxFQUFFLENBQUMsQ0FDdkQsQ0FBQyxJQUFJLENBQUMsS0FBSyxFQUFFLENBQUMsQ0FBQztRQUNSLFlBQU8sR0FBMkIsS0FBSyxDQUMzQyxTQUFTLENBQUMsUUFBUSxFQUFFLFNBQVMsQ0FBQyxFQUM5QixTQUFTLENBQUMsUUFBUSxFQUFFLFVBQVUsQ0FBQyxFQUMvQixTQUFTLENBQUMsUUFBUSxFQUFFLGFBQWEsQ0FBQyxDQUNyQyxDQUFDLElBQUksQ0FBQyxLQUFLLEVBQUUsQ0FBQyxDQUFDO1FBRVIsV0FBTSxHQUFHO1lBQ2IsWUFBWSxFQUFFLElBQUk7WUFDbEIsTUFBTSxFQUFFLElBQUk7WUFDWixVQUFVLEVBQUUsRUFBRTtZQUNkLGVBQWUsRUFBRSxJQUFJO1NBQ3hCLENBQUM7UUFDRix3Q0FBd0M7UUFDaEMsMEJBQXFCLEdBQUcsRUFBRSxDQUFDO1FBRy9CLElBQUksQ0FBQyxPQUFPLEdBQUcsT0FBTyxDQUFDO1FBQ3ZCLElBQUksQ0FBQyxTQUFTLEdBQUcsS0FBSyxDQUNsQixTQUFTLENBQUMsT0FBTyxFQUFFLFdBQVcsQ0FBQyxFQUMvQixTQUFTLENBQUMsT0FBTyxFQUFFLFlBQVksQ0FBQyxDQUNuQyxDQUFDLElBQUksQ0FBQyxLQUFLLEVBQUUsQ0FBQyxDQUFDO1FBRWhCLElBQUksQ0FBQyxNQUFNLHlCQUFRLElBQUksQ0FBQyxNQUFNLEdBQUssTUFBTSxDQUFFLENBQUM7UUFFNUMsSUFBSSxDQUFDLFNBQVMsR0FBRyxJQUFJLENBQUMseUJBQXlCLEVBQUUsQ0FBQyxJQUFJLENBQUMsS0FBSyxFQUFFLENBQUMsQ0FBQztRQUNoRSxJQUFJLENBQUMsUUFBUSxHQUFHLElBQUksQ0FBQyx3QkFBd0IsQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDLENBQUM7UUFDOUQsSUFBSSxDQUFDLFFBQVEsR0FBRyxJQUFJLENBQUMsd0JBQXdCLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxDQUFDO1FBRTlELElBQUksQ0FBQyxzQkFBc0IsQ0FBQyxPQUFPLENBQUMsQ0FBQztRQUVyQyxJQUFJLENBQUMscUJBQXFCO1lBQ3RCLE1BQU0sQ0FBQyxxQkFBcUIsSUFBSSxDQUFDLFVBQUEsUUFBUSxJQUFJLE9BQUEsVUFBVSxDQUFDLFFBQVEsRUFBRSxJQUFJLEdBQUcsRUFBRSxDQUFDLEVBQS9CLENBQStCLENBQUMsQ0FBQztRQUNsRixJQUFJLENBQUMsb0JBQW9CLEdBQUcsTUFBTSxDQUFDLG9CQUFvQixJQUFJLENBQUMsVUFBQSxLQUFLLElBQUksT0FBQSxZQUFZLENBQUMsS0FBSyxDQUFDLEVBQW5CLENBQW1CLENBQUMsQ0FBQztJQUM5RixDQUFDO0lBRU8sNkNBQXlCLEdBQWpDO1FBQUEsaUJBd0JDO1FBdkJHLE9BQU8sSUFBSSxDQUFDLFNBQVMsQ0FBQyxJQUFJLENBQ3RCLEdBQUcsQ0FBQyxVQUFBLEVBQUUsSUFBSSxPQUFBLElBQUksY0FBYyxDQUFDLEVBQUUsQ0FBQyxFQUF0QixDQUFzQixDQUFDLEVBQ2pDLE1BQU0sQ0FBQyxVQUFDLEtBQXFCLElBQUssT0FBQSxLQUFJLENBQUMsa0JBQWtCLENBQUMsS0FBSyxDQUFDLEVBQTlCLENBQThCLENBQUMsRUFDakUsR0FBRyxDQUFDLFVBQUEsQ0FBQztZQUNELElBQUksQ0FBQyxDQUFDLENBQUMsWUFBWSxFQUFFLEVBQUU7Z0JBQ25CLENBQUMsQ0FBQyxVQUFVLEVBQUUsQ0FBQzthQUNsQjtZQUNELElBQUksUUFBUSxDQUFDLGFBQWEsRUFBRTtnQkFDbEIsUUFBUSxDQUFDLGFBQWMsQ0FBQyxJQUFJLEVBQUUsQ0FBQzthQUN4QztZQUNELGtGQUFrRjtZQUNsRixLQUFLLENBQUMsY0FBYyxFQUFFLENBQUM7UUFDM0IsQ0FBQyxDQUFDLEVBQ0YsU0FBUyxDQUFDLFVBQUMsVUFBMEI7WUFDakMsT0FBTyxLQUFJLENBQUMsU0FBUyxDQUFDLElBQUksQ0FDdEIsR0FBRyxDQUFDLFVBQUEsRUFBRSxJQUFJLE9BQUEsSUFBSSxjQUFjLENBQUMsRUFBRSxDQUFDLEVBQXRCLENBQXNCLENBQUMsRUFDakMsTUFBTSxDQUFDLFVBQUMsU0FBeUIsSUFBSyxPQUFBLEtBQUksQ0FBQyxPQUFPLENBQUMsVUFBVSxFQUFFLFNBQVMsRUFBRSxDQUFDLENBQUMsRUFBdEMsQ0FBc0MsQ0FBQyxFQUM3RSxHQUFHLENBQUMsY0FBTSxPQUFBLFVBQVUsRUFBVixDQUFVLENBQUMsRUFDckIsU0FBUyxDQUFDLEtBQUksQ0FBQyxPQUFPLENBQUMsRUFDdkIsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUNWLENBQUM7UUFDTixDQUFDLENBQUMsQ0FDTCxDQUFDO0lBQ04sQ0FBQztJQUVPLDRDQUF3QixHQUFoQyxVQUNJLFNBQXFDO1FBRHpDLGlCQXlCQztRQXRCRyxPQUFPLFNBQVMsQ0FBQyxJQUFJLENBQ2pCLEdBQUcsQ0FBQyxVQUFBLEtBQUs7WUFDTCxLQUFJLENBQUMsa0JBQWtCLENBQUMsS0FBSyxDQUFDLE1BQU0sQ0FBQyxDQUFDO1FBQzFDLENBQUMsQ0FBQyxFQUNGLFNBQVMsQ0FBQyxVQUFBLFVBQVU7WUFDaEIsT0FBTyxLQUFJLENBQUMsU0FBUyxDQUFDLElBQUksQ0FDdEIsSUFBSSxDQUFDLENBQUMsQ0FBQyxFQUNQLEdBQUcsQ0FBQyxVQUFBLEVBQUUsSUFBSSxPQUFBLElBQUksY0FBYyxDQUFDLEVBQUUsQ0FBQyxFQUF0QixDQUFzQixDQUFDLEVBQ2pDLEdBQUcsQ0FBQyxVQUFBLEtBQUs7Z0JBQ0wsS0FBSyxDQUFDLFVBQVUsRUFBRSxDQUFDO2dCQUNuQixVQUFVLENBQUMsVUFBVSxFQUFFLENBQUM7WUFDNUIsQ0FBQyxDQUFDLEVBQ0YsU0FBUyxDQUFDLEtBQUksQ0FBQyxPQUFPLENBQUMsQ0FDMUIsQ0FBQztRQUNOLENBQUMsQ0FBQyxFQUNGLE1BQU0sQ0FBQyxVQUFBLEdBQUcsSUFBSSxPQUFBLENBQUMsQ0FBQyxHQUFHLEVBQUwsQ0FBSyxDQUFDLEVBQ3BCLEdBQUcsQ0FBQyxVQUFDLEtBQXFCO1lBQ3RCLElBQUksS0FBSSxDQUFDLE1BQU0sQ0FBQyxNQUFNLEVBQUU7Z0JBQ3BCLEtBQUksQ0FBQyxXQUFXLENBQUMsS0FBSSxDQUFDLE9BQU8sRUFBRSxLQUFLLENBQUMsQ0FBQzthQUN6QztRQUNMLENBQUMsQ0FBQyxDQUNMLENBQUM7SUFDTixDQUFDO0lBRU8sNENBQXdCLEdBQWhDLFVBQWlDLFNBQXFDO1FBQXRFLGlCQWFDO1FBWkcsT0FBTyxTQUFTLENBQUMsSUFBSSxDQUNqQixTQUFTLENBQUM7WUFDTixPQUFPLEtBQUksQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO1FBQ3RDLENBQUMsQ0FBQyxFQUNGLEdBQUcsQ0FBQyxVQUFBLENBQUMsSUFBSSxPQUFBLElBQUksY0FBYyxDQUFDLENBQUMsQ0FBQyxFQUFyQixDQUFxQixDQUFDLEVBQy9CLEdBQUcsQ0FBQyxVQUFBLENBQUM7WUFDRCxJQUFJLENBQUMsQ0FBQyxNQUFNLEVBQUU7Z0JBQ1YsS0FBSSxDQUFDLHFCQUFxQixDQUFDLENBQUMsQ0FBQyxNQUFNLENBQUMsQ0FBQzthQUN4QztZQUNELEtBQUksQ0FBQyxxQkFBcUIsQ0FBQyxPQUFPLENBQUMsVUFBQSxHQUFHLElBQUksT0FBQSxLQUFJLENBQUMsb0JBQW9CLENBQUMsR0FBRyxDQUFDLEVBQTlCLENBQThCLENBQUMsQ0FBQztRQUM5RSxDQUFDLENBQUMsQ0FDTCxDQUFDO0lBQ04sQ0FBQztJQUVPLCtCQUFXLEdBQW5CLFVBQW9CLElBQWEsRUFBRSxLQUFxQjtRQUF4RCxpQkFTQztRQVJHLElBQU0sZUFBZSxHQUFHLElBQUksQ0FBQyxrQkFBa0IsQ0FBQyxJQUFJLENBQUMsQ0FBQztRQUN0RCxJQUFJLENBQUMscUJBQXFCLENBQUMsT0FBTyxDQUFDLFVBQUEsR0FBRyxJQUFJLE9BQUEsS0FBSSxDQUFDLG9CQUFvQixDQUFDLEdBQUcsQ0FBQyxFQUE5QixDQUE4QixDQUFDLENBQUM7UUFFMUUsSUFBSSxlQUFlLEVBQUU7WUFDakIsSUFBSSxDQUFDLHVCQUF1QixDQUFDLEtBQUssRUFBRSxlQUFlLENBQUMsQ0FBQztTQUN4RDthQUFNO1lBQ0gsSUFBSSxDQUFDLG9CQUFvQixDQUFDLEtBQUssQ0FBQyxDQUFDO1NBQ3BDO0lBQ0wsQ0FBQztJQUVPLDJDQUF1QixHQUEvQixVQUFnQyxLQUFxQixFQUFFLGVBQTRCO1FBQy9FLElBQUksQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLGVBQWUsSUFBSSxJQUFJLENBQUMsTUFBTSxDQUFDLGVBQWUsS0FBSyxVQUFVLEVBQUU7WUFDNUUsSUFBSSxDQUFDLGlDQUFpQyxDQUFDLEtBQUssRUFBRSxlQUFlLENBQUMsQ0FBQztTQUNsRTtRQUVELElBQUksQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLGVBQWUsSUFBSSxJQUFJLENBQUMsTUFBTSxDQUFDLGVBQWUsS0FBSyxZQUFZLEVBQUU7WUFDOUUsSUFBSSxDQUFDLG1DQUFtQyxDQUFDLEtBQUssRUFBRSxlQUFlLENBQUMsQ0FBQztTQUNwRTtJQUNMLENBQUM7SUFFTyxxREFBaUMsR0FBekMsVUFDSSxLQUFxQixFQUNyQixlQUE0QjtRQUU1QixJQUFJLEtBQUssQ0FBQyxLQUFLLEdBQUcsSUFBSSxDQUFDLFNBQVMsQ0FBQyxlQUFlLENBQUMsQ0FBQyxHQUFHLEdBQUcsSUFBSSxDQUFDLE1BQU0sQ0FBQyxVQUFVLEVBQUU7WUFDNUUsSUFBSSxDQUFDLGtCQUFrQixDQUFDLGVBQWUsRUFBRSxDQUFDLFNBQVMsQ0FBQyxZQUFZLEVBQUUsV0FBVyxDQUFDLENBQUM7U0FDbEY7YUFBTSxJQUNILElBQUksQ0FBQyxTQUFTLENBQUMsZUFBZSxDQUFDLENBQUMsR0FBRztZQUMvQixlQUFlLENBQUMscUJBQXFCLEVBQUUsQ0FBQyxNQUFNO1lBQzlDLEtBQUssQ0FBQyxLQUFLO1lBQ2YsSUFBSSxDQUFDLE1BQU0sQ0FBQyxVQUFVLEVBQ3hCO1lBQ0UsSUFBSSxDQUFDLGtCQUFrQixDQUFDLGVBQWUsRUFBRSxTQUFTLENBQUMsWUFBWSxFQUFFLFdBQVcsQ0FBQyxDQUFDO1NBQ2pGO0lBQ0wsQ0FBQztJQUVPLHVEQUFtQyxHQUEzQyxVQUNJLEtBQXFCLEVBQ3JCLGVBQTRCO1FBRTVCLElBQUksS0FBSyxDQUFDLEtBQUssR0FBRyxlQUFlLENBQUMscUJBQXFCLEVBQUUsQ0FBQyxJQUFJLEdBQUcsSUFBSSxDQUFDLE1BQU0sQ0FBQyxVQUFVLEVBQUU7WUFDckYsSUFBSSxDQUFDLGtCQUFrQixDQUFDLGVBQWUsRUFBRSxDQUFDLFNBQVMsQ0FBQyxZQUFZLEVBQUUsWUFBWSxDQUFDLENBQUM7U0FDbkY7YUFBTSxJQUNILElBQUksQ0FBQyxTQUFTLENBQUMsZUFBZSxDQUFDLENBQUMsSUFBSTtZQUNoQyxlQUFlLENBQUMscUJBQXFCLEVBQUUsQ0FBQyxLQUFLO1lBQzdDLEtBQUssQ0FBQyxLQUFLO1lBQ2YsSUFBSSxDQUFDLE1BQU0sQ0FBQyxVQUFVLEVBQ3hCO1lBQ0UsSUFBSSxDQUFDLGtCQUFrQixDQUFDLGVBQWUsRUFBRSxTQUFTLENBQUMsWUFBWSxFQUFFLFlBQVksQ0FBQyxDQUFDO1NBQ2xGO0lBQ0wsQ0FBQztJQUVPLHdDQUFvQixHQUE1QixVQUE2QixLQUFLO1FBQzlCLElBQUksQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLGVBQWUsSUFBSSxJQUFJLENBQUMsTUFBTSxDQUFDLGVBQWUsS0FBSyxVQUFVLEVBQUU7WUFDNUUsSUFBSSxDQUFDLDhCQUE4QixDQUFDLEtBQUssQ0FBQyxDQUFDO1NBQzlDO1FBRUQsSUFBSSxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsZUFBZSxJQUFJLElBQUksQ0FBQyxNQUFNLENBQUMsZUFBZSxLQUFLLFlBQVksRUFBRTtZQUM5RSxJQUFJLENBQUMsZ0NBQWdDLENBQUMsS0FBSyxDQUFDLENBQUM7U0FDaEQ7SUFDTCxDQUFDO0lBRU8sa0RBQThCLEdBQXRDLFVBQXVDLEtBQXFCO1FBQ3hELElBQU0sZ0JBQWdCLEdBQ2xCLFFBQVEsQ0FBQyxnQkFBZ0IsSUFBSSxRQUFRLENBQUMsZUFBZSxJQUFJLFFBQVEsQ0FBQyxJQUFJLENBQUM7UUFFM0Usa0ZBQWtGO1FBQ2xGLElBQUksS0FBSyxDQUFDLEtBQUssR0FBRyxNQUFNLENBQUMsV0FBVyxHQUFHLElBQUksQ0FBQyxNQUFNLENBQUMsVUFBVSxFQUFFO1lBQzNELElBQUksQ0FBQyxrQkFBa0IsQ0FBQyxnQkFBZ0IsRUFBRSxDQUFDLFNBQVMsQ0FBQyxZQUFZLEVBQUUsV0FBVyxDQUFDLENBQUM7U0FDbkY7YUFBTSxJQUNILE1BQU0sQ0FBQyxXQUFXLEdBQUcsQ0FBQyxLQUFLLENBQUMsS0FBSyxHQUFHLE1BQU0sQ0FBQyxXQUFXLENBQUM7WUFDdkQsSUFBSSxDQUFDLE1BQU0sQ0FBQyxVQUFVLEVBQ3hCO1lBQ0UsSUFBSSxDQUFDLGtCQUFrQixDQUFDLGdCQUFnQixFQUFFLFNBQVMsQ0FBQyxZQUFZLEVBQUUsV0FBVyxDQUFDLENBQUM7U0FDbEY7SUFDTCxDQUFDO0lBRU8sb0RBQWdDLEdBQXhDLFVBQXlDLEtBQXFCO1FBQzFELElBQU0sZ0JBQWdCLEdBQ2xCLFFBQVEsQ0FBQyxnQkFBZ0IsSUFBSSxRQUFRLENBQUMsZUFBZSxJQUFJLFFBQVEsQ0FBQyxJQUFJLENBQUM7UUFFM0Usa0ZBQWtGO1FBQ2xGLElBQUksS0FBSyxDQUFDLEtBQUssR0FBRyxNQUFNLENBQUMsV0FBVyxHQUFHLElBQUksQ0FBQyxNQUFNLENBQUMsVUFBVSxFQUFFO1lBQzNELElBQUksQ0FBQyxrQkFBa0IsQ0FBQyxnQkFBZ0IsRUFBRSxDQUFDLFNBQVMsQ0FBQyxZQUFZLEVBQUUsWUFBWSxDQUFDLENBQUM7U0FDcEY7YUFBTSxJQUNILE1BQU0sQ0FBQyxVQUFVLEdBQUcsQ0FBQyxLQUFLLENBQUMsS0FBSyxHQUFHLE1BQU0sQ0FBQyxXQUFXLENBQUM7WUFDdEQsSUFBSSxDQUFDLE1BQU0sQ0FBQyxVQUFVLEVBQ3hCO1lBQ0UsSUFBSSxDQUFDLGtCQUFrQixDQUFDLGdCQUFnQixFQUFFLFNBQVMsQ0FBQyxZQUFZLEVBQUUsWUFBWSxDQUFDLENBQUM7U0FDbkY7SUFDTCxDQUFDO0lBRU8sc0NBQWtCLEdBQTFCLFVBQTJCLElBQUk7UUFDM0IsSUFBTSxlQUFlLEdBQUcsS0FBSyxDQUFDLHFCQUFxQixDQUFDLElBQUksQ0FBQyxDQUFDO1FBRTFELElBQUksSUFBSSxDQUFDLFlBQVksR0FBRyxJQUFJLENBQUMsSUFBSSxDQUFDLGVBQWUsQ0FBQyxFQUFFO1lBQ2hELE9BQU8sSUFBSSxDQUFDO1NBQ2Y7UUFFRCxJQUFJLENBQUMsSUFBSSxNQUFNLENBQUMsYUFBYSxFQUFFLEdBQUcsQ0FBQyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsVUFBVSxDQUFDLE9BQU8sQ0FBQyxFQUFFO1lBQy9ELE9BQU8sSUFBSSxDQUFDLGtCQUFrQixDQUFDLElBQUksQ0FBQyxVQUFVLENBQUMsQ0FBQztTQUNuRDtRQUVELE9BQU8sSUFBSSxDQUFDO0lBQ2hCLENBQUM7SUFFTyxzQ0FBa0IsR0FBMUIsVUFBMkIsSUFBSSxFQUFFLE1BQU0sRUFBRSxTQUFTO1FBQzlDLElBQUksQ0FBQyxxQkFBcUIsQ0FBQyxJQUFJLENBQzNCLElBQUksQ0FBQyxxQkFBcUIsQ0FDdEI7WUFDSSxJQUFJLENBQUMsa0JBQWtCLENBQUMsSUFBSSxFQUFFLE1BQU0sRUFBRSxTQUFTLENBQUMsQ0FBQztRQUNyRCxDQUFDLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUNmLENBQ0osQ0FBQztRQUVGLE9BQU8sQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDLElBQUksTUFBTSxHQUFHLElBQUksQ0FBQyxDQUFDO0lBQzlDLENBQUM7SUFFTyw2QkFBUyxHQUFqQixVQUFrQixFQUFFO1FBQ2hCLElBQU0sSUFBSSxHQUFHLEVBQUUsQ0FBQyxxQkFBcUIsRUFBRSxDQUFDO1FBQ3hDLE9BQU87WUFDSCxJQUFJLEVBQUUsSUFBSSxDQUFDLElBQUksR0FBRyxJQUFJLENBQUMsU0FBUyxDQUFDLFlBQVksRUFBRSxhQUFhLENBQUM7WUFDN0QsR0FBRyxFQUFFLElBQUksQ0FBQyxHQUFHLEdBQUcsSUFBSSxDQUFDLFNBQVMsQ0FBQyxXQUFXLEVBQUUsYUFBYSxDQUFDO1NBQzdELENBQUM7SUFDTixDQUFDO0lBRU8sNkJBQVMsR0FBakIsVUFBa0IsVUFBVSxFQUFFLFVBQVU7UUFDcEMsSUFBSSxPQUFPLE1BQU0sQ0FBQyxVQUFVLENBQUMsS0FBSyxXQUFXLEVBQUU7WUFDM0MsT0FBTyxNQUFNLENBQUMsVUFBVSxDQUFDLENBQUM7U0FDN0I7UUFDRCxJQUFJLFFBQVEsQ0FBQyxlQUFlLENBQUMsWUFBWSxFQUFFO1lBQ3ZDLE9BQU8sUUFBUSxDQUFDLGVBQWUsQ0FBQyxVQUFVLENBQUMsQ0FBQztTQUMvQztRQUNELE9BQU8sUUFBUSxDQUFDLElBQUksQ0FBQyxVQUFVLENBQUMsQ0FBQztJQUNyQyxDQUFDO0lBRU8sc0NBQWtCLEdBQTFCLFVBQTJCLEtBQXFCO1FBQzVDLElBQUksQ0FBQyxJQUFJLENBQUMsa0JBQWtCLENBQUMsS0FBSyxDQUFDLE1BQU0sQ0FBQyxFQUFFO1lBQ3hDLE9BQU8sS0FBSyxDQUFDO1NBQ2hCO1FBRUQsT0FBTyxDQUNILENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxZQUFZO1lBQ3pCLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxZQUFZO2dCQUNyQixJQUFJLENBQUMsbUJBQW1CLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxZQUFZLEVBQUUsS0FBSyxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQ3hFLENBQUM7SUFDTixDQUFDO0lBRU8sc0NBQWtCLEdBQTFCLFVBQTJCLFFBQWE7UUFDcEMsT0FBTyxDQUFDLE9BQU8sRUFBRSxVQUFVLENBQUMsQ0FBQyxPQUFPLENBQUMsUUFBUSxDQUFDLE9BQU8sQ0FBQyxXQUFXLEVBQUUsQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDO0lBQ2hGLENBQUM7SUFFTywyQkFBTyxHQUFmLFVBQWdCLFVBQTBCLEVBQUUsU0FBeUIsRUFBRSxLQUFhO1FBQ2hGLE9BQU8sQ0FDSCxJQUFJLENBQUMsR0FBRyxDQUFDLFNBQVMsQ0FBQyxPQUFPLEdBQUcsVUFBVSxDQUFDLE9BQU8sQ0FBQyxHQUFHLEtBQUs7WUFDeEQsSUFBSSxDQUFDLEdBQUcsQ0FBQyxTQUFTLENBQUMsT0FBTyxHQUFHLFVBQVUsQ0FBQyxPQUFPLENBQUMsR0FBRyxLQUFLLENBQzNELENBQUM7SUFDTixDQUFDO0lBRU8sdUNBQW1CLEdBQTNCLFVBQTRCLFNBQWlCLEVBQUUsTUFBVztRQUN0RCxPQUFPLE1BQU0sS0FBSyxJQUFJLENBQUMsT0FBTyxFQUFFO1lBQzVCLElBQUksTUFBTSxDQUFDLFNBQVMsQ0FBQyxRQUFRLENBQUMsU0FBUyxDQUFDLEVBQUU7Z0JBQ3RDLE9BQU8sSUFBSSxDQUFDO2FBQ2Y7WUFDRCxNQUFNLEdBQUcsTUFBTSxDQUFDLGFBQWEsQ0FBQztTQUNqQztRQUNELE9BQU8sS0FBSyxDQUFDO0lBQ2pCLENBQUM7SUFFTyw4QkFBVSxHQUFsQixVQUFtQixDQUFRO1FBQ3ZCLElBQUksQ0FBQyxDQUFDLGVBQWUsRUFBRTtZQUNuQixDQUFDLENBQUMsZUFBZSxFQUFFLENBQUM7U0FDdkI7UUFDRCxJQUFJLENBQUMsQ0FBQyxjQUFjLEVBQUU7WUFDbEIsQ0FBQyxDQUFDLGNBQWMsRUFBRSxDQUFDO1NBQ3RCO1FBQ0QsQ0FBQyxDQUFDLFlBQVksR0FBRyxJQUFJLENBQUM7UUFDdEIsQ0FBQyxDQUFDLFdBQVcsR0FBRyxLQUFLLENBQUM7SUFDMUIsQ0FBQztJQUVPLDBDQUFzQixHQUE5QixVQUErQixPQUFnQjtRQUMzQyxJQUFJLElBQUksQ0FBQyxhQUFhLEVBQUUsSUFBSSxJQUFJLENBQUMsVUFBVSxFQUFFLElBQWtCLE9BQVEsQ0FBQyxLQUFLLEVBQUU7WUFDN0QsT0FBUSxDQUFDLEtBQUssQ0FBQyxjQUFjLENBQUMsR0FBRyxNQUFNLENBQUM7U0FDekQ7SUFDTCxDQUFDO0lBRU8seUNBQXFCLEdBQTdCLFVBQThCLE9BQWdCO1FBQzFDLElBQUksQ0FBZSxPQUFRLENBQUMsS0FBSyxFQUFFO1lBQy9CLE9BQU87U0FDVjtRQUNhLE9BQVEsQ0FBQyxLQUFLLENBQUMsY0FBYyxDQUFDLEdBQUcsRUFBRSxDQUFDO0lBQ3RELENBQUM7SUFFTyxzQ0FBa0IsR0FBMUIsVUFBMkIsT0FBTztRQUM5QixJQUFJLENBQWUsT0FBUSxDQUFDLEtBQUssRUFBRTtZQUMvQixPQUFPO1NBQ1Y7UUFDYSxPQUFRLENBQUMsS0FBSyxDQUFDLGNBQWMsQ0FBQyxHQUFHLE1BQU0sQ0FBQztJQUMxRCxDQUFDO0lBRU8saUNBQWEsR0FBckI7UUFDSSxPQUFPLENBQ0gsY0FBYyxJQUFJLE1BQU0sSUFBSSxTQUFTLENBQUMsY0FBYyxDQUFDLHlCQUF5QjtTQUNqRixDQUFDLENBQUMsK0JBQStCO0lBQ3RDLENBQUM7SUFFTyw4QkFBVSxHQUFsQjtRQUNJLElBQU0sRUFBRSxHQUFHLE1BQU0sQ0FBQyxTQUFTLENBQUMsU0FBUyxDQUFDO1FBRXRDLElBQU0sSUFBSSxHQUFHLEVBQUUsQ0FBQyxPQUFPLENBQUMsT0FBTyxDQUFDLENBQUM7UUFDakMsSUFBSSxJQUFJLEdBQUcsQ0FBQyxFQUFFO1lBQ1YsMENBQTBDO1lBQzFDLE9BQU8sUUFBUSxDQUFDLEVBQUUsQ0FBQyxTQUFTLENBQUMsSUFBSSxHQUFHLENBQUMsRUFBRSxFQUFFLENBQUMsT0FBTyxDQUFDLEdBQUcsRUFBRSxJQUFJLENBQUMsQ0FBQyxFQUFFLEVBQUUsQ0FBQyxDQUFDO1NBQ3RFO1FBRUQsSUFBTSxPQUFPLEdBQUcsRUFBRSxDQUFDLE9BQU8sQ0FBQyxVQUFVLENBQUMsQ0FBQztRQUN2QyxJQUFJLE9BQU8sR0FBRyxDQUFDLEVBQUU7WUFDYixpQ0FBaUM7WUFDakMsSUFBTSxFQUFFLEdBQUcsRUFBRSxDQUFDLE9BQU8sQ0FBQyxLQUFLLENBQUMsQ0FBQztZQUM3QixPQUFPLFFBQVEsQ0FBQyxFQUFFLENBQUMsU0FBUyxDQUFDLEVBQUUsR0FBRyxDQUFDLEVBQUUsRUFBRSxDQUFDLE9BQU8sQ0FBQyxHQUFHLEVBQUUsRUFBRSxDQUFDLENBQUMsRUFBRSxFQUFFLENBQUMsQ0FBQztTQUNsRTtRQUVELElBQU0sSUFBSSxHQUFHLEVBQUUsQ0FBQyxPQUFPLENBQUMsT0FBTyxDQUFDLENBQUM7UUFDakMsSUFBSSxJQUFJLEdBQUcsQ0FBQyxFQUFFO1lBQ1YseUNBQXlDO1lBQ3pDLE9BQU8sUUFBUSxDQUFDLEVBQUUsQ0FBQyxTQUFTLENBQUMsSUFBSSxHQUFHLENBQUMsRUFBRSxFQUFFLENBQUMsT0FBTyxDQUFDLEdBQUcsRUFBRSxJQUFJLENBQUMsQ0FBQyxFQUFFLEVBQUUsQ0FBQyxDQUFDO1NBQ3RFO1FBRUQsZ0JBQWdCO1FBQ2hCLE9BQU8sS0FBSyxDQUFDO0lBQ2pCLENBQUM7SUEzVk0sc0JBQVksR0FBRyxFQUFFLENBQUM7SUE0VjdCLGdCQUFDO0NBQUEsQUE3VkQsSUE2VkM7U0E3VlksU0FBUyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IE9ic2VydmFibGUsIGZyb21FdmVudCwgbWVyZ2UsIHBpcGUgfSBmcm9tICdyeGpzJztcbmltcG9ydCB7IHNoYXJlLCBtYXAsIGZpbHRlciwgdGFwLCBzd2l0Y2hNYXAsIHRha2VVbnRpbCwgdGFrZSwgc2tpcCB9IGZyb20gJ3J4anMvb3BlcmF0b3JzJztcblxuaW1wb3J0IHsgRHJhZ2dhYmxlRXZlbnQgfSBmcm9tICcuL0RyYWdnYWJsZUV2ZW50JztcbmltcG9ydCB7IHV0aWxzIH0gZnJvbSAnLi91dGlscyc7XG5cbmV4cG9ydCBjbGFzcyBEcmFnZ2FibGUge1xuICAgIHN0YXRpYyBTQ1JPTExfU1BFRUQgPSAyMDtcbiAgICBlbGVtZW50OiBFbGVtZW50O1xuXG4gICAgZHJhZ1N0YXJ0OiBPYnNlcnZhYmxlPERyYWdnYWJsZUV2ZW50PjtcbiAgICBkcmFnTW92ZTogT2JzZXJ2YWJsZTxEcmFnZ2FibGVFdmVudD47XG4gICAgZHJhZ1N0b3A6IE9ic2VydmFibGU8RHJhZ2dhYmxlRXZlbnQ+O1xuICAgIC8vIEEgc2ltcGxlIHJlcXVlc3RBbmltYXRpb25GcmFtZSBwb2x5ZmlsbFxuICAgIHByaXZhdGUgcmVxdWVzdEFuaW1hdGlvbkZyYW1lOiBGdW5jdGlvbjtcbiAgICBwcml2YXRlIGNhbmNlbEFuaW1hdGlvbkZyYW1lOiBGdW5jdGlvbjtcbiAgICBwcml2YXRlIG1vdXNlbW92ZTogT2JzZXJ2YWJsZTx7fSB8IEV2ZW50PiA9IG1lcmdlKFxuICAgICAgICBmcm9tRXZlbnQoZG9jdW1lbnQsICdtb3VzZW1vdmUnKSxcbiAgICAgICAgZnJvbUV2ZW50KGRvY3VtZW50LCAndG91Y2htb3ZlJywgeyBwYXNzaXZlOiBmYWxzZSB9KVxuICAgICkucGlwZShzaGFyZSgpKTtcbiAgICBwcml2YXRlIG1vdXNldXA6IE9ic2VydmFibGU8e30gfCBFdmVudD4gPSBtZXJnZShcbiAgICAgICAgZnJvbUV2ZW50KGRvY3VtZW50LCAnbW91c2V1cCcpLFxuICAgICAgICBmcm9tRXZlbnQoZG9jdW1lbnQsICd0b3VjaGVuZCcpLFxuICAgICAgICBmcm9tRXZlbnQoZG9jdW1lbnQsICd0b3VjaGNhbmNlbCcpXG4gICAgKS5waXBlKHNoYXJlKCkpO1xuICAgIHByaXZhdGUgbW91c2Vkb3duOiBPYnNlcnZhYmxlPHt9IHwgRXZlbnQ+O1xuICAgIHByaXZhdGUgY29uZmlnID0ge1xuICAgICAgICBoYW5kbGVyQ2xhc3M6IG51bGwsXG4gICAgICAgIHNjcm9sbDogdHJ1ZSxcbiAgICAgICAgc2Nyb2xsRWRnZTogMzYsXG4gICAgICAgIHNjcm9sbERpcmVjdGlvbjogbnVsbFxuICAgIH07XG4gICAgLy8gcmVmZXJlbmNlIHRvIGF1dG8gc2Nyb2xsaW5nIGxpc3RlbmVyc1xuICAgIHByaXZhdGUgYXV0b1Njcm9sbGluZ0ludGVydmFsID0gW107XG5cbiAgICBjb25zdHJ1Y3RvcihlbGVtZW50OiBFbGVtZW50LCBjb25maWcgPSB7fSkge1xuICAgICAgICB0aGlzLmVsZW1lbnQgPSBlbGVtZW50O1xuICAgICAgICB0aGlzLm1vdXNlZG93biA9IG1lcmdlKFxuICAgICAgICAgICAgZnJvbUV2ZW50KGVsZW1lbnQsICdtb3VzZWRvd24nKSxcbiAgICAgICAgICAgIGZyb21FdmVudChlbGVtZW50LCAndG91Y2hzdGFydCcpXG4gICAgICAgICkucGlwZShzaGFyZSgpKTtcblxuICAgICAgICB0aGlzLmNvbmZpZyA9IHsgLi4udGhpcy5jb25maWcsIC4uLmNvbmZpZyB9O1xuXG4gICAgICAgIHRoaXMuZHJhZ1N0YXJ0ID0gdGhpcy5jcmVhdGVEcmFnU3RhcnRPYnNlcnZhYmxlKCkucGlwZShzaGFyZSgpKTtcbiAgICAgICAgdGhpcy5kcmFnTW92ZSA9IHRoaXMuY3JlYXRlRHJhZ01vdmVPYnNlcnZhYmxlKHRoaXMuZHJhZ1N0YXJ0KTtcbiAgICAgICAgdGhpcy5kcmFnU3RvcCA9IHRoaXMuY3JlYXRlRHJhZ1N0b3BPYnNlcnZhYmxlKHRoaXMuZHJhZ1N0YXJ0KTtcblxuICAgICAgICB0aGlzLmZpeFByb2JsZW1XaXRoRG5ERm9ySUUoZWxlbWVudCk7XG5cbiAgICAgICAgdGhpcy5yZXF1ZXN0QW5pbWF0aW9uRnJhbWUgPVxuICAgICAgICAgICAgd2luZG93LnJlcXVlc3RBbmltYXRpb25GcmFtZSB8fCAoY2FsbGJhY2sgPT4gc2V0VGltZW91dChjYWxsYmFjaywgMTAwMCAvIDYwKSk7XG4gICAgICAgIHRoaXMuY2FuY2VsQW5pbWF0aW9uRnJhbWUgPSB3aW5kb3cuY2FuY2VsQW5pbWF0aW9uRnJhbWUgfHwgKGNhZklEID0+IGNsZWFyVGltZW91dChjYWZJRCkpO1xuICAgIH1cblxuICAgIHByaXZhdGUgY3JlYXRlRHJhZ1N0YXJ0T2JzZXJ2YWJsZSgpOiBPYnNlcnZhYmxlPERyYWdnYWJsZUV2ZW50PiB7XG4gICAgICAgIHJldHVybiB0aGlzLm1vdXNlZG93bi5waXBlKFxuICAgICAgICAgICAgbWFwKG1kID0+IG5ldyBEcmFnZ2FibGVFdmVudChtZCkpLFxuICAgICAgICAgICAgZmlsdGVyKChldmVudDogRHJhZ2dhYmxlRXZlbnQpID0+IHRoaXMuaXNEcmFnaW5nQnlIYW5kbGVyKGV2ZW50KSksXG4gICAgICAgICAgICB0YXAoZSA9PiB7XG4gICAgICAgICAgICAgICAgaWYgKCFlLmlzVG91Y2hFdmVudCgpKSB7XG4gICAgICAgICAgICAgICAgICAgIGUucGF1c2VFdmVudCgpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBpZiAoZG9jdW1lbnQuYWN0aXZlRWxlbWVudCkge1xuICAgICAgICAgICAgICAgICAgICAoPGFueT5kb2N1bWVudC5hY3RpdmVFbGVtZW50KS5ibHVyKCk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIC8vIHByZXZlbnRzIHJlbmRlcmluZyBwZXJmb3JtYW5jZSBpc3N1ZXMgd2hpbGUgZHJhZ2dpbmcgaXRlbSB3aXRoIHNlbGVjdGlvbiBpbnNpZGVcbiAgICAgICAgICAgICAgICB1dGlscy5jbGVhclNlbGVjdGlvbigpO1xuICAgICAgICAgICAgfSksXG4gICAgICAgICAgICBzd2l0Y2hNYXAoKHN0YXJ0RXZlbnQ6IERyYWdnYWJsZUV2ZW50KSA9PiB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMubW91c2Vtb3ZlLnBpcGUoXG4gICAgICAgICAgICAgICAgICAgIG1hcChtbSA9PiBuZXcgRHJhZ2dhYmxlRXZlbnQobW0pKSxcbiAgICAgICAgICAgICAgICAgICAgZmlsdGVyKChtb3ZlRXZlbnQ6IERyYWdnYWJsZUV2ZW50KSA9PiB0aGlzLmluUmFuZ2Uoc3RhcnRFdmVudCwgbW92ZUV2ZW50LCA1KSksXG4gICAgICAgICAgICAgICAgICAgIG1hcCgoKSA9PiBzdGFydEV2ZW50KSxcbiAgICAgICAgICAgICAgICAgICAgdGFrZVVudGlsKHRoaXMubW91c2V1cCksXG4gICAgICAgICAgICAgICAgICAgIHRha2UoMSlcbiAgICAgICAgICAgICAgICApO1xuICAgICAgICAgICAgfSlcbiAgICAgICAgKTtcbiAgICB9XG5cbiAgICBwcml2YXRlIGNyZWF0ZURyYWdNb3ZlT2JzZXJ2YWJsZShcbiAgICAgICAgZHJhZ1N0YXJ0OiBPYnNlcnZhYmxlPERyYWdnYWJsZUV2ZW50PlxuICAgICk6IE9ic2VydmFibGU8RHJhZ2dhYmxlRXZlbnQ+IHtcbiAgICAgICAgcmV0dXJuIGRyYWdTdGFydC5waXBlKFxuICAgICAgICAgICAgdGFwKGV2ZW50ID0+IHtcbiAgICAgICAgICAgICAgICB0aGlzLmFkZFRvdWNoQWN0aW9uTm9uZShldmVudC50YXJnZXQpO1xuICAgICAgICAgICAgfSksXG4gICAgICAgICAgICBzd2l0Y2hNYXAoc3RhcnRFdmVudCA9PiB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMubW91c2Vtb3ZlLnBpcGUoXG4gICAgICAgICAgICAgICAgICAgIHNraXAoMSksXG4gICAgICAgICAgICAgICAgICAgIG1hcChtbSA9PiBuZXcgRHJhZ2dhYmxlRXZlbnQobW0pKSxcbiAgICAgICAgICAgICAgICAgICAgdGFwKGV2ZW50ID0+IHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGV2ZW50LnBhdXNlRXZlbnQoKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIHN0YXJ0RXZlbnQucGF1c2VFdmVudCgpO1xuICAgICAgICAgICAgICAgICAgICB9KSxcbiAgICAgICAgICAgICAgICAgICAgdGFrZVVudGlsKHRoaXMubW91c2V1cClcbiAgICAgICAgICAgICAgICApO1xuICAgICAgICAgICAgfSksXG4gICAgICAgICAgICBmaWx0ZXIodmFsID0+ICEhdmFsKSxcbiAgICAgICAgICAgIHRhcCgoZXZlbnQ6IERyYWdnYWJsZUV2ZW50KSA9PiB7XG4gICAgICAgICAgICAgICAgaWYgKHRoaXMuY29uZmlnLnNjcm9sbCkge1xuICAgICAgICAgICAgICAgICAgICB0aGlzLnN0YXJ0U2Nyb2xsKHRoaXMuZWxlbWVudCwgZXZlbnQpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0pXG4gICAgICAgICk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBjcmVhdGVEcmFnU3RvcE9ic2VydmFibGUoZHJhZ1N0YXJ0OiBPYnNlcnZhYmxlPERyYWdnYWJsZUV2ZW50Pik6IE9ic2VydmFibGU8YW55PiB7XG4gICAgICAgIHJldHVybiBkcmFnU3RhcnQucGlwZShcbiAgICAgICAgICAgIHN3aXRjaE1hcCgoKSA9PiB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMubW91c2V1cC5waXBlKHRha2UoMSkpO1xuICAgICAgICAgICAgfSksXG4gICAgICAgICAgICBtYXAoZSA9PiBuZXcgRHJhZ2dhYmxlRXZlbnQoZSkpLFxuICAgICAgICAgICAgdGFwKGUgPT4ge1xuICAgICAgICAgICAgICAgIGlmIChlLnRhcmdldCkge1xuICAgICAgICAgICAgICAgICAgICB0aGlzLnJlbW92ZVRvdWNoQWN0aW9uTm9uZShlLnRhcmdldCk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIHRoaXMuYXV0b1Njcm9sbGluZ0ludGVydmFsLmZvckVhY2gocmFmID0+IHRoaXMuY2FuY2VsQW5pbWF0aW9uRnJhbWUocmFmKSk7XG4gICAgICAgICAgICB9KVxuICAgICAgICApO1xuICAgIH1cblxuICAgIHByaXZhdGUgc3RhcnRTY3JvbGwoaXRlbTogRWxlbWVudCwgZXZlbnQ6IERyYWdnYWJsZUV2ZW50KSB7XG4gICAgICAgIGNvbnN0IHNjcm9sbENvbnRhaW5lciA9IHRoaXMuZ2V0U2Nyb2xsQ29udGFpbmVyKGl0ZW0pO1xuICAgICAgICB0aGlzLmF1dG9TY3JvbGxpbmdJbnRlcnZhbC5mb3JFYWNoKHJhZiA9PiB0aGlzLmNhbmNlbEFuaW1hdGlvbkZyYW1lKHJhZikpO1xuXG4gICAgICAgIGlmIChzY3JvbGxDb250YWluZXIpIHtcbiAgICAgICAgICAgIHRoaXMuc3RhcnRTY3JvbGxGb3JDb250YWluZXIoZXZlbnQsIHNjcm9sbENvbnRhaW5lcik7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICB0aGlzLnN0YXJ0U2Nyb2xsRm9yV2luZG93KGV2ZW50KTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIHByaXZhdGUgc3RhcnRTY3JvbGxGb3JDb250YWluZXIoZXZlbnQ6IERyYWdnYWJsZUV2ZW50LCBzY3JvbGxDb250YWluZXI6IEhUTUxFbGVtZW50KTogdm9pZCB7XG4gICAgICAgIGlmICghdGhpcy5jb25maWcuc2Nyb2xsRGlyZWN0aW9uIHx8IHRoaXMuY29uZmlnLnNjcm9sbERpcmVjdGlvbiA9PT0gJ3ZlcnRpY2FsJykge1xuICAgICAgICAgICAgdGhpcy5zdGFydFNjcm9sbFZlcnRpY2FsbHlGb3JDb250YWluZXIoZXZlbnQsIHNjcm9sbENvbnRhaW5lcik7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAoIXRoaXMuY29uZmlnLnNjcm9sbERpcmVjdGlvbiB8fCB0aGlzLmNvbmZpZy5zY3JvbGxEaXJlY3Rpb24gPT09ICdob3Jpem9udGFsJykge1xuICAgICAgICAgICAgdGhpcy5zdGFydFNjcm9sbEhvcml6b250YWxseUZvckNvbnRhaW5lcihldmVudCwgc2Nyb2xsQ29udGFpbmVyKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIHByaXZhdGUgc3RhcnRTY3JvbGxWZXJ0aWNhbGx5Rm9yQ29udGFpbmVyKFxuICAgICAgICBldmVudDogRHJhZ2dhYmxlRXZlbnQsXG4gICAgICAgIHNjcm9sbENvbnRhaW5lcjogSFRNTEVsZW1lbnRcbiAgICApOiB2b2lkIHtcbiAgICAgICAgaWYgKGV2ZW50LnBhZ2VZIC0gdGhpcy5nZXRPZmZzZXQoc2Nyb2xsQ29udGFpbmVyKS50b3AgPCB0aGlzLmNvbmZpZy5zY3JvbGxFZGdlKSB7XG4gICAgICAgICAgICB0aGlzLnN0YXJ0QXV0b1Njcm9sbGluZyhzY3JvbGxDb250YWluZXIsIC1EcmFnZ2FibGUuU0NST0xMX1NQRUVELCAnc2Nyb2xsVG9wJyk7XG4gICAgICAgIH0gZWxzZSBpZiAoXG4gICAgICAgICAgICB0aGlzLmdldE9mZnNldChzY3JvbGxDb250YWluZXIpLnRvcCArXG4gICAgICAgICAgICAgICAgc2Nyb2xsQ29udGFpbmVyLmdldEJvdW5kaW5nQ2xpZW50UmVjdCgpLmhlaWdodCAtXG4gICAgICAgICAgICAgICAgZXZlbnQucGFnZVkgPFxuICAgICAgICAgICAgdGhpcy5jb25maWcuc2Nyb2xsRWRnZVxuICAgICAgICApIHtcbiAgICAgICAgICAgIHRoaXMuc3RhcnRBdXRvU2Nyb2xsaW5nKHNjcm9sbENvbnRhaW5lciwgRHJhZ2dhYmxlLlNDUk9MTF9TUEVFRCwgJ3Njcm9sbFRvcCcpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBzdGFydFNjcm9sbEhvcml6b250YWxseUZvckNvbnRhaW5lcihcbiAgICAgICAgZXZlbnQ6IERyYWdnYWJsZUV2ZW50LFxuICAgICAgICBzY3JvbGxDb250YWluZXI6IEhUTUxFbGVtZW50XG4gICAgKTogdm9pZCB7XG4gICAgICAgIGlmIChldmVudC5wYWdlWCAtIHNjcm9sbENvbnRhaW5lci5nZXRCb3VuZGluZ0NsaWVudFJlY3QoKS5sZWZ0IDwgdGhpcy5jb25maWcuc2Nyb2xsRWRnZSkge1xuICAgICAgICAgICAgdGhpcy5zdGFydEF1dG9TY3JvbGxpbmcoc2Nyb2xsQ29udGFpbmVyLCAtRHJhZ2dhYmxlLlNDUk9MTF9TUEVFRCwgJ3Njcm9sbExlZnQnKTtcbiAgICAgICAgfSBlbHNlIGlmIChcbiAgICAgICAgICAgIHRoaXMuZ2V0T2Zmc2V0KHNjcm9sbENvbnRhaW5lcikubGVmdCArXG4gICAgICAgICAgICAgICAgc2Nyb2xsQ29udGFpbmVyLmdldEJvdW5kaW5nQ2xpZW50UmVjdCgpLndpZHRoIC1cbiAgICAgICAgICAgICAgICBldmVudC5wYWdlWCA8XG4gICAgICAgICAgICB0aGlzLmNvbmZpZy5zY3JvbGxFZGdlXG4gICAgICAgICkge1xuICAgICAgICAgICAgdGhpcy5zdGFydEF1dG9TY3JvbGxpbmcoc2Nyb2xsQ29udGFpbmVyLCBEcmFnZ2FibGUuU0NST0xMX1NQRUVELCAnc2Nyb2xsTGVmdCcpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBzdGFydFNjcm9sbEZvcldpbmRvdyhldmVudCkge1xuICAgICAgICBpZiAoIXRoaXMuY29uZmlnLnNjcm9sbERpcmVjdGlvbiB8fCB0aGlzLmNvbmZpZy5zY3JvbGxEaXJlY3Rpb24gPT09ICd2ZXJ0aWNhbCcpIHtcbiAgICAgICAgICAgIHRoaXMuc3RhcnRTY3JvbGxWZXJ0aWNhbGx5Rm9yV2luZG93KGV2ZW50KTtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmICghdGhpcy5jb25maWcuc2Nyb2xsRGlyZWN0aW9uIHx8IHRoaXMuY29uZmlnLnNjcm9sbERpcmVjdGlvbiA9PT0gJ2hvcml6b250YWwnKSB7XG4gICAgICAgICAgICB0aGlzLnN0YXJ0U2Nyb2xsSG9yaXpvbnRhbGx5Rm9yV2luZG93KGV2ZW50KTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIHByaXZhdGUgc3RhcnRTY3JvbGxWZXJ0aWNhbGx5Rm9yV2luZG93KGV2ZW50OiBEcmFnZ2FibGVFdmVudCk6IHZvaWQge1xuICAgICAgICBjb25zdCBzY3JvbGxpbmdFbGVtZW50ID1cbiAgICAgICAgICAgIGRvY3VtZW50LnNjcm9sbGluZ0VsZW1lbnQgfHwgZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50IHx8IGRvY3VtZW50LmJvZHk7XG5cbiAgICAgICAgLy8gTk9URTogVXNpbmcgYHdpbmRvdy5wYWdlWU9mZnNldGAgaGVyZSBiZWNhdXNlIElFIGRvZXNuJ3QgaGF2ZSBgd2luZG93LnNjcm9sbFlgLlxuICAgICAgICBpZiAoZXZlbnQucGFnZVkgLSB3aW5kb3cucGFnZVlPZmZzZXQgPCB0aGlzLmNvbmZpZy5zY3JvbGxFZGdlKSB7XG4gICAgICAgICAgICB0aGlzLnN0YXJ0QXV0b1Njcm9sbGluZyhzY3JvbGxpbmdFbGVtZW50LCAtRHJhZ2dhYmxlLlNDUk9MTF9TUEVFRCwgJ3Njcm9sbFRvcCcpO1xuICAgICAgICB9IGVsc2UgaWYgKFxuICAgICAgICAgICAgd2luZG93LmlubmVySGVpZ2h0IC0gKGV2ZW50LnBhZ2VZIC0gd2luZG93LnBhZ2VZT2Zmc2V0KSA8XG4gICAgICAgICAgICB0aGlzLmNvbmZpZy5zY3JvbGxFZGdlXG4gICAgICAgICkge1xuICAgICAgICAgICAgdGhpcy5zdGFydEF1dG9TY3JvbGxpbmcoc2Nyb2xsaW5nRWxlbWVudCwgRHJhZ2dhYmxlLlNDUk9MTF9TUEVFRCwgJ3Njcm9sbFRvcCcpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBzdGFydFNjcm9sbEhvcml6b250YWxseUZvcldpbmRvdyhldmVudDogRHJhZ2dhYmxlRXZlbnQpOiB2b2lkIHtcbiAgICAgICAgY29uc3Qgc2Nyb2xsaW5nRWxlbWVudCA9XG4gICAgICAgICAgICBkb2N1bWVudC5zY3JvbGxpbmdFbGVtZW50IHx8IGRvY3VtZW50LmRvY3VtZW50RWxlbWVudCB8fCBkb2N1bWVudC5ib2R5O1xuXG4gICAgICAgIC8vIE5PVEU6IFVzaW5nIGB3aW5kb3cucGFnZVhPZmZzZXRgIGhlcmUgYmVjYXVzZSBJRSBkb2Vzbid0IGhhdmUgYHdpbmRvdy5zY3JvbGxYYC5cbiAgICAgICAgaWYgKGV2ZW50LnBhZ2VYIC0gd2luZG93LnBhZ2VYT2Zmc2V0IDwgdGhpcy5jb25maWcuc2Nyb2xsRWRnZSkge1xuICAgICAgICAgICAgdGhpcy5zdGFydEF1dG9TY3JvbGxpbmcoc2Nyb2xsaW5nRWxlbWVudCwgLURyYWdnYWJsZS5TQ1JPTExfU1BFRUQsICdzY3JvbGxMZWZ0Jyk7XG4gICAgICAgIH0gZWxzZSBpZiAoXG4gICAgICAgICAgICB3aW5kb3cuaW5uZXJXaWR0aCAtIChldmVudC5wYWdlWCAtIHdpbmRvdy5wYWdlWE9mZnNldCkgPFxuICAgICAgICAgICAgdGhpcy5jb25maWcuc2Nyb2xsRWRnZVxuICAgICAgICApIHtcbiAgICAgICAgICAgIHRoaXMuc3RhcnRBdXRvU2Nyb2xsaW5nKHNjcm9sbGluZ0VsZW1lbnQsIERyYWdnYWJsZS5TQ1JPTExfU1BFRUQsICdzY3JvbGxMZWZ0Jyk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBwcml2YXRlIGdldFNjcm9sbENvbnRhaW5lcihub2RlKTogSFRNTEVsZW1lbnQge1xuICAgICAgICBjb25zdCBub2RlT3V0ZXJIZWlnaHQgPSB1dGlscy5nZXRFbGVtZW50T3V0ZXJIZWlnaHQobm9kZSk7XG5cbiAgICAgICAgaWYgKG5vZGUuc2Nyb2xsSGVpZ2h0ID4gTWF0aC5jZWlsKG5vZGVPdXRlckhlaWdodCkpIHtcbiAgICAgICAgICAgIHJldHVybiBub2RlO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKCFuZXcgUmVnRXhwKCcoYm9keXxodG1sKScsICdpJykudGVzdChub2RlLnBhcmVudE5vZGUudGFnTmFtZSkpIHtcbiAgICAgICAgICAgIHJldHVybiB0aGlzLmdldFNjcm9sbENvbnRhaW5lcihub2RlLnBhcmVudE5vZGUpO1xuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIG51bGw7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBzdGFydEF1dG9TY3JvbGxpbmcobm9kZSwgYW1vdW50LCBkaXJlY3Rpb24pIHtcbiAgICAgICAgdGhpcy5hdXRvU2Nyb2xsaW5nSW50ZXJ2YWwucHVzaChcbiAgICAgICAgICAgIHRoaXMucmVxdWVzdEFuaW1hdGlvbkZyYW1lKFxuICAgICAgICAgICAgICAgIGZ1bmN0aW9uKCkge1xuICAgICAgICAgICAgICAgICAgICB0aGlzLnN0YXJ0QXV0b1Njcm9sbGluZyhub2RlLCBhbW91bnQsIGRpcmVjdGlvbik7XG4gICAgICAgICAgICAgICAgfS5iaW5kKHRoaXMpXG4gICAgICAgICAgICApXG4gICAgICAgICk7XG5cbiAgICAgICAgcmV0dXJuIChub2RlW2RpcmVjdGlvbl0gKz0gYW1vdW50ICogMC4yNSk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBnZXRPZmZzZXQoZWwpIHtcbiAgICAgICAgY29uc3QgcmVjdCA9IGVsLmdldEJvdW5kaW5nQ2xpZW50UmVjdCgpO1xuICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgbGVmdDogcmVjdC5sZWZ0ICsgdGhpcy5nZXRTY3JvbGwoJ3Njcm9sbExlZnQnLCAncGFnZVhPZmZzZXQnKSxcbiAgICAgICAgICAgIHRvcDogcmVjdC50b3AgKyB0aGlzLmdldFNjcm9sbCgnc2Nyb2xsVG9wJywgJ3BhZ2VZT2Zmc2V0JylcbiAgICAgICAgfTtcbiAgICB9XG5cbiAgICBwcml2YXRlIGdldFNjcm9sbChzY3JvbGxQcm9wLCBvZmZzZXRQcm9wKSB7XG4gICAgICAgIGlmICh0eXBlb2Ygd2luZG93W29mZnNldFByb3BdICE9PSAndW5kZWZpbmVkJykge1xuICAgICAgICAgICAgcmV0dXJuIHdpbmRvd1tvZmZzZXRQcm9wXTtcbiAgICAgICAgfVxuICAgICAgICBpZiAoZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50LmNsaWVudEhlaWdodCkge1xuICAgICAgICAgICAgcmV0dXJuIGRvY3VtZW50LmRvY3VtZW50RWxlbWVudFtzY3JvbGxQcm9wXTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gZG9jdW1lbnQuYm9keVtzY3JvbGxQcm9wXTtcbiAgICB9XG5cbiAgICBwcml2YXRlIGlzRHJhZ2luZ0J5SGFuZGxlcihldmVudDogRHJhZ2dhYmxlRXZlbnQpOiBib29sZWFuIHtcbiAgICAgICAgaWYgKCF0aGlzLmlzVmFsaWREcmFnSGFuZGxlcihldmVudC50YXJnZXQpKSB7XG4gICAgICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gKFxuICAgICAgICAgICAgIXRoaXMuY29uZmlnLmhhbmRsZXJDbGFzcyB8fFxuICAgICAgICAgICAgKHRoaXMuY29uZmlnLmhhbmRsZXJDbGFzcyAmJlxuICAgICAgICAgICAgICAgIHRoaXMuaGFzRWxlbWVudFdpdGhDbGFzcyh0aGlzLmNvbmZpZy5oYW5kbGVyQ2xhc3MsIGV2ZW50LnRhcmdldCkpXG4gICAgICAgICk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBpc1ZhbGlkRHJhZ0hhbmRsZXIodGFyZ2V0RWw6IGFueSk6IGJvb2xlYW4ge1xuICAgICAgICByZXR1cm4gWydpbnB1dCcsICd0ZXh0YXJlYSddLmluZGV4T2YodGFyZ2V0RWwudGFnTmFtZS50b0xvd2VyQ2FzZSgpKSA9PT0gLTE7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBpblJhbmdlKHN0YXJ0RXZlbnQ6IERyYWdnYWJsZUV2ZW50LCBtb3ZlRXZlbnQ6IERyYWdnYWJsZUV2ZW50LCByYW5nZTogbnVtYmVyKTogYm9vbGVhbiB7XG4gICAgICAgIHJldHVybiAoXG4gICAgICAgICAgICBNYXRoLmFicyhtb3ZlRXZlbnQuY2xpZW50WCAtIHN0YXJ0RXZlbnQuY2xpZW50WCkgPiByYW5nZSB8fFxuICAgICAgICAgICAgTWF0aC5hYnMobW92ZUV2ZW50LmNsaWVudFkgLSBzdGFydEV2ZW50LmNsaWVudFkpID4gcmFuZ2VcbiAgICAgICAgKTtcbiAgICB9XG5cbiAgICBwcml2YXRlIGhhc0VsZW1lbnRXaXRoQ2xhc3MoY2xhc3NOYW1lOiBzdHJpbmcsIHRhcmdldDogYW55KTogYm9vbGVhbiB7XG4gICAgICAgIHdoaWxlICh0YXJnZXQgIT09IHRoaXMuZWxlbWVudCkge1xuICAgICAgICAgICAgaWYgKHRhcmdldC5jbGFzc0xpc3QuY29udGFpbnMoY2xhc3NOYW1lKSkge1xuICAgICAgICAgICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgdGFyZ2V0ID0gdGFyZ2V0LnBhcmVudEVsZW1lbnQ7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgIH1cblxuICAgIHByaXZhdGUgcGF1c2VFdmVudChlOiBFdmVudCk6IHZvaWQge1xuICAgICAgICBpZiAoZS5zdG9wUHJvcGFnYXRpb24pIHtcbiAgICAgICAgICAgIGUuc3RvcFByb3BhZ2F0aW9uKCk7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKGUucHJldmVudERlZmF1bHQpIHtcbiAgICAgICAgICAgIGUucHJldmVudERlZmF1bHQoKTtcbiAgICAgICAgfVxuICAgICAgICBlLmNhbmNlbEJ1YmJsZSA9IHRydWU7XG4gICAgICAgIGUucmV0dXJuVmFsdWUgPSBmYWxzZTtcbiAgICB9XG5cbiAgICBwcml2YXRlIGZpeFByb2JsZW1XaXRoRG5ERm9ySUUoZWxlbWVudDogRWxlbWVudCkge1xuICAgICAgICBpZiAodGhpcy5pc1RvdWNoRGV2aWNlKCkgJiYgdGhpcy5pc0lFb3JFZGdlKCkgJiYgKDxIVE1MRWxlbWVudD5lbGVtZW50KS5zdHlsZSkge1xuICAgICAgICAgICAgKDxIVE1MRWxlbWVudD5lbGVtZW50KS5zdHlsZVsndG91Y2gtYWN0aW9uJ10gPSAnbm9uZSc7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBwcml2YXRlIHJlbW92ZVRvdWNoQWN0aW9uTm9uZShlbGVtZW50OiBFbGVtZW50KSB7XG4gICAgICAgIGlmICghKDxIVE1MRWxlbWVudD5lbGVtZW50KS5zdHlsZSkge1xuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG4gICAgICAgICg8SFRNTEVsZW1lbnQ+ZWxlbWVudCkuc3R5bGVbJ3RvdWNoLWFjdGlvbiddID0gJyc7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBhZGRUb3VjaEFjdGlvbk5vbmUoZWxlbWVudCkge1xuICAgICAgICBpZiAoISg8SFRNTEVsZW1lbnQ+ZWxlbWVudCkuc3R5bGUpIHtcbiAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuICAgICAgICAoPEhUTUxFbGVtZW50PmVsZW1lbnQpLnN0eWxlWyd0b3VjaC1hY3Rpb24nXSA9ICdub25lJztcbiAgICB9XG5cbiAgICBwcml2YXRlIGlzVG91Y2hEZXZpY2UoKSB7XG4gICAgICAgIHJldHVybiAoXG4gICAgICAgICAgICAnb250b3VjaHN0YXJ0JyBpbiB3aW5kb3cgfHwgbmF2aWdhdG9yLm1heFRvdWNoUG9pbnRzIC8vIHdvcmtzIG9uIG1vc3QgYnJvd3NlcnNcbiAgICAgICAgKTsgLy8gd29ya3Mgb24gSUUxMC8xMSBhbmQgU3VyZmFjZVxuICAgIH1cblxuICAgIHByaXZhdGUgaXNJRW9yRWRnZSgpIHtcbiAgICAgICAgY29uc3QgdWEgPSB3aW5kb3cubmF2aWdhdG9yLnVzZXJBZ2VudDtcblxuICAgICAgICBjb25zdCBtc2llID0gdWEuaW5kZXhPZignTVNJRSAnKTtcbiAgICAgICAgaWYgKG1zaWUgPiAwKSB7XG4gICAgICAgICAgICAvLyBJRSAxMCBvciBvbGRlciA9PiByZXR1cm4gdmVyc2lvbiBudW1iZXJcbiAgICAgICAgICAgIHJldHVybiBwYXJzZUludCh1YS5zdWJzdHJpbmcobXNpZSArIDUsIHVhLmluZGV4T2YoJy4nLCBtc2llKSksIDEwKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGNvbnN0IHRyaWRlbnQgPSB1YS5pbmRleE9mKCdUcmlkZW50LycpO1xuICAgICAgICBpZiAodHJpZGVudCA+IDApIHtcbiAgICAgICAgICAgIC8vIElFIDExID0+IHJldHVybiB2ZXJzaW9uIG51bWJlclxuICAgICAgICAgICAgY29uc3QgcnYgPSB1YS5pbmRleE9mKCdydjonKTtcbiAgICAgICAgICAgIHJldHVybiBwYXJzZUludCh1YS5zdWJzdHJpbmcocnYgKyAzLCB1YS5pbmRleE9mKCcuJywgcnYpKSwgMTApO1xuICAgICAgICB9XG5cbiAgICAgICAgY29uc3QgZWRnZSA9IHVhLmluZGV4T2YoJ0VkZ2UvJyk7XG4gICAgICAgIGlmIChlZGdlID4gMCkge1xuICAgICAgICAgICAgLy8gRWRnZSAoSUUgMTIrKSA9PiByZXR1cm4gdmVyc2lvbiBudW1iZXJcbiAgICAgICAgICAgIHJldHVybiBwYXJzZUludCh1YS5zdWJzdHJpbmcoZWRnZSArIDUsIHVhLmluZGV4T2YoJy4nLCBlZGdlKSksIDEwKTtcbiAgICAgICAgfVxuXG4gICAgICAgIC8vIG90aGVyIGJyb3dzZXJcbiAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgIH1cbn1cbiJdfQ==