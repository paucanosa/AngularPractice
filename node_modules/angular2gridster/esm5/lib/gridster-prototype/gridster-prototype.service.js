import { __decorate, __metadata } from "tslib";
import { Injectable } from '@angular/core';
import { Subject, merge } from 'rxjs';
import { takeUntil, switchMap, map, scan, filter, share, tap } from 'rxjs/operators';
import { utils } from '../utils/utils';
var GridsterPrototypeService = /** @class */ (function () {
    function GridsterPrototypeService() {
        this.isDragging = false;
        this.dragSubject = new Subject();
        this.dragStartSubject = new Subject();
        this.dragStopSubject = new Subject();
    }
    GridsterPrototypeService.prototype.observeDropOver = function (gridster) {
        var _this = this;
        return this.dragStopSubject.pipe(filter(function (data) {
            var gridsterEl = gridster.gridsterComponent.$element;
            var isOverNestedGridster = [].slice.call(gridsterEl.querySelectorAll('gridster'))
                .reduce(function (isOverGridster, nestedGridsterEl) {
                return isOverGridster ||
                    _this.isOverGridster(data.item, nestedGridsterEl, data.event, gridster.options);
            }, false);
            if (isOverNestedGridster) {
                return false;
            }
            return _this.isOverGridster(data.item, gridsterEl, data.event, gridster.options);
        }), tap(function (data) {
            // TODO: what we should provide as a param?
            // prototype.drop.emit({item: prototype.item});
            data.item.onDrop(gridster);
        }));
    };
    GridsterPrototypeService.prototype.observeDropOut = function (gridster) {
        var _this = this;
        return this.dragStopSubject.pipe(filter(function (data) {
            var gridsterEl = gridster.gridsterComponent.$element;
            return !_this.isOverGridster(data.item, gridsterEl, data.event, gridster.options);
        }), tap(function (data) {
            // TODO: what we should provide as a param?
            data.item.onCancel();
        }));
    };
    GridsterPrototypeService.prototype.observeDragOver = function (gridster) {
        var _this = this;
        var over = this.dragSubject.pipe(map(function (data) {
            var gridsterEl = gridster.gridsterComponent.$element;
            return {
                item: data.item,
                event: data.event,
                isOver: _this.isOverGridster(data.item, gridsterEl, data.event, gridster.options),
                isDrop: false
            };
        }));
        var drop = this.dragStopSubject.pipe(map(function (data) {
            var gridsterEl = gridster.gridsterComponent.$element;
            return {
                item: data.item,
                event: data.event,
                isOver: _this.isOverGridster(data.item, gridsterEl, data.event, gridster.options),
                isDrop: true
            };
        }));
        var dragExt = merge(
        // dragStartSubject is connected in case when item prototype is placed above gridster
        // and drag enter is not fired
        this.dragStartSubject.pipe(map(function () { return ({ item: null, isOver: false, isDrop: false }); })), over, drop).pipe(scan(function (prev, next) {
            return {
                item: next.item,
                event: next.event,
                isOver: next.isOver,
                isEnter: prev.isOver === false && next.isOver === true,
                isOut: prev.isOver === true && next.isOver === false && !prev.isDrop,
                isDrop: next.isDrop
            };
        }), filter(function (data) {
            return !data.isDrop;
        }), share());
        var dragEnter = this.createDragEnterObservable(dragExt, gridster);
        var dragOut = this.createDragOutObservable(dragExt, gridster);
        var dragOver = dragEnter
            .pipe(switchMap(function () { return _this.dragSubject.pipe(takeUntil(dragOut)); }), map(function (data) { return data.item; }));
        return { dragEnter: dragEnter, dragOut: dragOut, dragOver: dragOver };
    };
    GridsterPrototypeService.prototype.dragItemStart = function (item, event) {
        this.isDragging = true;
        this.dragStartSubject.next({ item: item, event: event });
    };
    GridsterPrototypeService.prototype.dragItemStop = function (item, event) {
        this.isDragging = false;
        this.dragStopSubject.next({ item: item, event: event });
    };
    GridsterPrototypeService.prototype.updatePrototypePosition = function (item, event) {
        this.dragSubject.next({ item: item, event: event });
    };
    /**
     * Creates observable that is fired on dragging over gridster container.
     */
    GridsterPrototypeService.prototype.createDragOverObservable = function (dragIsOver, gridster) {
        return dragIsOver.pipe(filter(function (data) { return data.isOver && !data.isEnter && !data.isOut; }), map(function (data) { return data.item; }), tap(function (item) { return item.onOver(gridster); }));
    };
    /**
     * Creates observable that is fired on drag enter gridster container.
     */
    GridsterPrototypeService.prototype.createDragEnterObservable = function (dragIsOver, gridster) {
        return dragIsOver.pipe(filter(function (data) { return data.isEnter; }), map(function (data) { return data.item; }), tap(function (item) { return item.onEnter(gridster); }));
    };
    /**
     * Creates observable that is fired on drag out gridster container.
     */
    GridsterPrototypeService.prototype.createDragOutObservable = function (dragIsOver, gridster) {
        return dragIsOver.pipe(filter(function (data) { return data.isOut; }), map(function (data) { return data.item; }), tap(function (item) { return item.onOut(gridster); }));
    };
    /**
     * Checks whether "element" position fits inside "containerEl" position.
     * It checks if "element" is totally covered by "containerEl" area.
     */
    GridsterPrototypeService.prototype.isOverGridster = function (item, gridsterEl, event, options) {
        var el = item.$element;
        var parentItem = gridsterEl.parentElement &&
            gridsterEl.parentElement.closest('gridster-item');
        if (parentItem) {
            return this.isOverGridster(item, parentItem, event, options);
        }
        switch (options.tolerance) {
            case 'fit':
                return utils.isElementFitContainer(el, gridsterEl);
            case 'intersect':
                return utils.isElementIntersectContainer(el, gridsterEl);
            case 'touch':
                return utils.isElementTouchContainer(el, gridsterEl);
            default:
                return utils.isCursorAboveElement(event, gridsterEl);
        }
    };
    GridsterPrototypeService = __decorate([
        Injectable(),
        __metadata("design:paramtypes", [])
    ], GridsterPrototypeService);
    return GridsterPrototypeService;
}());
export { GridsterPrototypeService };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZ3JpZHN0ZXItcHJvdG90eXBlLnNlcnZpY2UuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9hbmd1bGFyMmdyaWRzdGVyLyIsInNvdXJjZXMiOlsibGliL2dyaWRzdGVyLXByb3RvdHlwZS9ncmlkc3Rlci1wcm90b3R5cGUuc2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUEsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUMzQyxPQUFPLEVBQWMsT0FBTyxFQUFFLEtBQUssRUFBRSxNQUFNLE1BQU0sQ0FBQztBQUNsRCxPQUFPLEVBQUUsU0FBUyxFQUFFLFNBQVMsRUFBRSxHQUFHLEVBQUUsSUFBSSxFQUFFLE1BQU0sRUFBRSxLQUFLLEVBQUUsR0FBRyxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFJckYsT0FBTyxFQUFFLEtBQUssRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBSXZDO0lBVUk7UUFSUSxlQUFVLEdBQUcsS0FBSyxDQUFDO1FBRW5CLGdCQUFXLEdBQUcsSUFBSSxPQUFPLEVBQU8sQ0FBQztRQUVqQyxxQkFBZ0IsR0FBRyxJQUFJLE9BQU8sRUFBTyxDQUFDO1FBRXRDLG9CQUFlLEdBQUcsSUFBSSxPQUFPLEVBQU8sQ0FBQztJQUU5QixDQUFDO0lBRWhCLGtEQUFlLEdBQWYsVUFBaUIsUUFBeUI7UUFBMUMsaUJBc0JDO1FBckJHLE9BQU8sSUFBSSxDQUFDLGVBQWUsQ0FBQyxJQUFJLENBQzVCLE1BQU0sQ0FBQyxVQUFDLElBQUk7WUFDUixJQUFNLFVBQVUsR0FBRyxRQUFRLENBQUMsaUJBQWlCLENBQUMsUUFBUSxDQUFDO1lBQ3ZELElBQU0sb0JBQW9CLEdBQUcsRUFBRSxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsVUFBVSxDQUFDLGdCQUFnQixDQUFDLFVBQVUsQ0FBQyxDQUFDO2lCQUM5RSxNQUFNLENBQUMsVUFBQyxjQUFjLEVBQUUsZ0JBQWdCO2dCQUNyQyxPQUFPLGNBQWM7b0JBQ2pCLEtBQUksQ0FBQyxjQUFj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LEVBQUU7WUFDdkIsS0FBSyxLQUFLO2dCQUNOLE9BQU8sS0FBSyxDQUFDLHFCQUFxQixDQUFDLEVBQUUsRUFBRSxVQUFVLENBQUMsQ0FBQztZQUN2RCxLQUFLLFdBQVc7Z0JBQ1osT0FBTyxLQUFLLENBQUMsMkJBQTJCLENBQUMsRUFBRSxFQUFFLFVBQVUsQ0FBQyxDQUFDO1lBQzdELEtBQUssT0FBTztnQkFDUixPQUFPLEtBQUssQ0FBQyx1QkFBdUIsQ0FBQyxFQUFFLEVBQUUsVUFBVSxDQUFDLENBQUM7WUFDekQ7Z0JBQ0ksT0FBTyxLQUFLLENBQUMsb0JBQW9CLENBQUMsS0FBSyxFQUFFLFVBQVUsQ0FBQyxDQUFDO1NBQzVEO0lBQ0wsQ0FBQztJQWpNUSx3QkFBd0I7UUFEcEMsVUFBVSxFQUFFOztPQUNBLHdCQUF3QixDQWtNcEM7SUFBRCwrQkFBQztDQUFBLEFBbE1ELElBa01DO1NBbE1ZLHdCQUF3QiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEluamVjdGFibGUgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IE9ic2VydmFibGUsIFN1YmplY3QsIG1lcmdlIH0gZnJvbSAncnhqcyc7XG5pbXBvcnQgeyB0YWtlVW50aWwsIHN3aXRjaE1hcCwgbWFwLCBzY2FuLCBmaWx0ZXIsIHNoYXJlLCB0YXAgfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XG5cbmltcG9ydCB7IEdyaWRzdGVyU2VydmljZSB9IGZyb20gJy4uL2dyaWRzdGVyLnNlcnZpY2UnO1xuaW1wb3J0IHsgR3JpZHN0ZXJJdGVtUHJvdG90eXBlRGlyZWN0aXZlIH0gZnJvbSAnLi9ncmlkc3Rlci1pdGVtLXByb3RvdHlwZS5kaXJlY3RpdmUnO1xuaW1wb3J0IHsgdXRpbHMgfSBmcm9tICcuLi91dGlscy91dGlscyc7XG5pbXBvcnQgeyBEcmFnZ2FibGVFdmVudCB9IGZyb20gJy4uL3V0aWxzL0RyYWdnYWJsZUV2ZW50JztcblxuQEluamVjdGFibGUoKVxuZXhwb3J0IGNsYXNzIEdyaWRzdGVyUHJvdG90eXBlU2VydmljZSB7XG5cbiAgICBwcml2YXRlIGlzRHJhZ2dpbmcgPSBmYWxzZTtcblxuICAgIHByaXZhdGUgZHJhZ1N1YmplY3QgPSBuZXcgU3ViamVjdDxhbnk+KCk7XG5cbiAgICBwcml2YXRlIGRyYWdTdGFydFN1YmplY3QgPSBuZXcgU3ViamVjdDxhbnk+KCk7XG5cbiAgICBwcml2YXRlIGRyYWdTdG9wU3ViamVjdCA9IG5ldyBTdWJqZWN0PGFueT4oKTtcblxuICAgIGNvbnN0cnVjdG9yKCkge31cblxuICAgIG9ic2VydmVEcm9wT3ZlciAoZ3JpZHN0ZXI6IEdyaWRzdGVyU2VydmljZSkge1xuICAgICAgICByZXR1cm4gdGhpcy5kcmFnU3RvcFN1YmplY3QucGlwZShcbiAgICAgICAgICAgIGZpbHRlcigoZGF0YSkgPT4ge1xuICAgICAgICAgICAgICAgIGNvbnN0IGdyaWRzdGVyRWwgPSBncmlkc3Rlci5ncmlkc3RlckNvbXBvbmVudC4kZWxlbWVudDtcbiAgICAgICAgICAgICAgICBjb25zdCBpc092ZXJOZXN0ZWRHcmlkc3RlciA9IFtdLnNsaWNlLmNhbGwoZ3JpZHN0ZXJFbC5xdWVyeVNlbGVjdG9yQWxsKCdncmlkc3RlcicpKVxuICAgICAgICAgICAgICAgICAgICAucmVkdWNlKChpc092ZXJHcmlkc3RlciwgbmVzdGVkR3JpZHN0ZXJFbCkgPT4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGlzT3ZlckdyaWRzdGVyIHx8XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5pc092ZXJHcmlkc3RlcihkYXRhLml0ZW0sIG5lc3RlZEdyaWRzdGVyRWwsIGRhdGEuZXZlbnQsIGdyaWRzdGVyLm9wdGlvbnMpO1xuICAgICAgICAgICAgICAgICAgICB9LCBmYWxzZSk7XG5cbiAgICAgICAgICAgICAgICBpZiAoaXNPdmVyTmVzdGVkR3JpZHN0ZXIpIHtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLmlzT3ZlckdyaWRzdGVyKGRhdGEuaXRlbSwgZ3JpZHN0ZXJFbCwgZGF0YS5ldmVudCwgZ3JpZHN0ZXIub3B0aW9ucyk7XG4gICAgICAgICAgICB9KSxcbiAgICAgICAgICAgIHRhcCgoZGF0YSkgPT4ge1xuICAgICAgICAgICAgICAgIC8vIFRPRE86IHdoYXQgd2Ugc2hvdWxkIHByb3ZpZGUgYXMgYSBwYXJhbT9cbiAgICAgICAgICAgICAgICAvLyBwcm90b3R5cGUuZHJvcC5lbWl0KHtpdGVtOiBwcm90b3R5cGUuaXRlbX0pO1xuICAgICAgICAgICAgICAgIGRhdGEuaXRlbS5vbkRyb3AoZ3JpZHN0ZXIpO1xuICAgICAgICAgICAgfSlcbiAgICAgICAgKTtcbiAgICB9XG5cbiAgICBvYnNlcnZlRHJvcE91dCAoZ3JpZHN0ZXI6IEdyaWRzdGVyU2VydmljZSkge1xuICAgICAgICByZXR1cm4gdGhpcy5kcmFnU3RvcFN1YmplY3QucGlwZShcbiAgICAgICAgICAgIGZpbHRlcigoZGF0YSkgPT4ge1xuICAgICAgICAgICAgICAgIGNvbnN0IGdyaWRzdGVyRWwgPSBncmlkc3Rlci5ncmlkc3RlckNvbXBvbmVudC4kZWxlbWVudDtcblxuICAgICAgICAgICAgICAgIHJldHVybiAhdGhpcy5pc092ZXJHcmlkc3RlcihkYXRhLml0ZW0sIGdyaWRzdGVyRWwsIGRhdGEuZXZlbnQsIGdyaWRzdGVyLm9wdGlvbnMpO1xuICAgICAgICAgICAgfSksXG4gICAgICAgICAgICB0YXAoKGRhdGEpID0+IHtcbiAgICAgICAgICAgICAgICAvLyBUT0RPOiB3aGF0IHdlIHNob3VsZCBwcm92aWRlIGFzIGEgcGFyYW0/XG4gICAgICAgICAgICAgICAgZGF0YS5pdGVtLm9uQ2FuY2VsKCk7XG4gICAgICAgICAgICB9KVxuICAgICAgICApO1xuICAgIH1cblxuICAgIG9ic2VydmVEcmFnT3Zlcihncmlkc3RlcjogR3JpZHN0ZXJTZXJ2aWNlKToge1xuICAgICAgICBkcmFnT3ZlcjogT2JzZXJ2YWJsZTxHcmlkc3Rlckl0ZW1Qcm90b3R5cGVEaXJlY3RpdmU+LFxuICAgICAgICBkcmFnRW50ZXI6IE9ic2VydmFibGU8R3JpZHN0ZXJJdGVtUHJvdG90eXBlRGlyZWN0aXZlPixcbiAgICAgICAgZHJhZ091dDogT2JzZXJ2YWJsZTxHcmlkc3Rlckl0ZW1Qcm90b3R5cGVEaXJlY3RpdmU+XG4gICAgfSB7XG4gICAgICAgIGNvbnN0IG92ZXIgPSB0aGlzLmRyYWdTdWJqZWN0LnBpcGUoXG4gICAgICAgICAgICBtYXAoKGRhdGEpID0+IHtcbiAgICAgICAgICAgICAgICBjb25zdCBncmlkc3RlckVsID0gZ3JpZHN0ZXIuZ3JpZHN0ZXJDb21wb25lbnQuJGVsZW1lbnQ7XG5cbiAgICAgICAgICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgICAgICAgaXRlbTogZGF0YS5pdGVtLFxuICAgICAgICAgICAgICAgICAgZXZlbnQ6IGRhdGEuZXZlbnQsXG4gICAgICAgICAgICAgICAgICBpc092ZXI6IHRoaXMuaXNPdmVyR3JpZHN0ZXIoZGF0YS5pdGVtLCBncmlkc3RlckVsLCBkYXRhLmV2ZW50LCBncmlkc3Rlci5vcHRpb25zKSxcbiAgICAgICAgICAgICAgICAgIGlzRHJvcDogZmFsc2VcbiAgICAgICAgICAgICAgICB9O1xuICAgICAgICAgICAgfSlcbiAgICAgICAgKTtcblxuICAgICAgICBjb25zdCBkcm9wID0gdGhpcy5kcmFnU3RvcFN1YmplY3QucGlwZShcbiAgICAgICAgICAgIG1hcCgoZGF0YSkgPT4ge1xuICAgICAgICAgICAgICAgIGNvbnN0IGdyaWRzdGVyRWwgPSBncmlkc3Rlci5ncmlkc3RlckNvbXBvbmVudC4kZWxlbWVudDtcblxuICAgICAgICAgICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICAgICAgICAgIGl0ZW06IGRhdGEuaXRlbSxcbiAgICAgICAgICAgICAgICAgICAgZXZlbnQ6IGRhdGEuZXZlbnQsXG4gICAgICAgICAgICAgICAgICAgIGlzT3ZlcjogdGhpcy5pc092ZXJHcmlkc3RlcihkYXRhLml0ZW0sIGdyaWRzdGVyRWwsIGRhdGEuZXZlbnQsIGdyaWRzdGVyLm9wdGlvbnMpLFxuICAgICAgICAgICAgICAgICAgICBpc0Ryb3A6IHRydWVcbiAgICAgICAgICAgICAgICB9O1xuICAgICAgICAgICAgfSlcbiAgICAgICAgKTtcblxuICAgICAgICBjb25zdCBkcmFnRXh0ID0gbWVyZ2UoXG4gICAgICAgICAgICAgICAgLy8gZHJhZ1N0YXJ0U3ViamVjdCBpcyBjb25uZWN0ZWQgaW4gY2FzZSB3aGVuIGl0ZW0gcHJvdG90eXBlIGlzIHBsYWNlZCBhYm92ZSBncmlkc3RlclxuICAgICAgICAgICAgICAgIC8vIGFuZCBkcmFnIGVudGVyIGlzIG5vdCBmaXJlZFxuICAgICAgICAgICAgICAgIHRoaXMuZHJhZ1N0YXJ0U3ViamVjdC5waXBlKG1hcCgoKSA9PiAoeyBpdGVtOiBudWxsLCBpc092ZXI6IGZhbHNlLCBpc0Ryb3A6IGZhbHNlIH0pKSksXG4gICAgICAgICAgICAgICAgb3ZlcixcbiAgICAgICAgICAgICAgICBkcm9wXG4gICAgICAgICAgICApLnBpcGUoXG4gICAgICAgICAgICAgICAgc2NhbigocHJldjogYW55LCBuZXh0OiBhbnkpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGl0ZW06IG5leHQuaXRlbSxcbiAgICAgICAgICAgICAgICAgICAgICAgIGV2ZW50OiBuZXh0LmV2ZW50LFxuICAgICAgICAgICAgICAgICAgICAgICAgaXNPdmVyOiBuZXh0LmlzT3ZlcixcbiAgICAgICAgICAgICAgICAgICAgICAgIGlzRW50ZXI6IHByZXYuaXNPdmVyID09PSBmYWxzZSAmJiBuZXh0LmlzT3ZlciA9PT0gdHJ1ZSxcbiAgICAgICAgICAgICAgICAgICAgICAgIGlzT3V0OiBwcmV2LmlzT3ZlciA9PT0gdHJ1ZSAmJiBuZXh0LmlzT3ZlciA9PT0gZmFsc2UgJiYgIXByZXYuaXNEcm9wLFxuICAgICAgICAgICAgICAgICAgICAgICAgaXNEcm9wOiBuZXh0LmlzRHJvcFxuICAgICAgICAgICAgICAgICAgICB9O1xuICAgICAgICAgICAgICAgIH0pLFxuICAgICAgICAgICAgICAgIGZpbHRlcigoZGF0YTogYW55KSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiAhZGF0YS5pc0Ryb3A7XG4gICAgICAgICAgICAgICAgfSksXG4gICAgICAgICAgICAgICAgc2hhcmUoKVxuICAgICAgICAgICAgKTtcblxuICAgICAgICBjb25zdCBkcmFnRW50ZXIgPSB0aGlzLmNyZWF0ZURyYWdFbnRlck9ic2VydmFibGUoZHJhZ0V4dCwgZ3JpZHN0ZXIpO1xuICAgICAgICBjb25zdCBkcmFnT3V0ID0gdGhpcy5jcmVhdGVEcmFnT3V0T2JzZXJ2YWJsZShkcmFnRXh0LCBncmlkc3Rlcik7XG4gICAgICAgIGNvbnN0IGRyYWdPdmVyID0gZHJhZ0VudGVyXG4gICAgICAgICAgICAucGlwZShcbiAgICAgICAgICAgICAgICBzd2l0Y2hNYXAoKCkgPT4gdGhpcy5kcmFnU3ViamVjdC5waXBlKHRha2VVbnRpbChkcmFnT3V0KSkpLFxuICAgICAgICAgICAgICAgIG1hcCgoZGF0YTogYW55KSA9PiBkYXRhLml0ZW0pXG4gICAgICAgICAgICApO1xuXG4gICAgICAgIHJldHVybiB7IGRyYWdFbnRlciwgZHJhZ091dCwgZHJhZ092ZXIgfTtcbiAgICB9XG5cbiAgICBkcmFnSXRlbVN0YXJ0KGl0ZW06IEdyaWRzdGVySXRlbVByb3RvdHlwZURpcmVjdGl2ZSwgZXZlbnQ6IERyYWdnYWJsZUV2ZW50KSB7XG4gICAgICAgIHRoaXMuaXNEcmFnZ2luZyA9IHRydWU7XG4gICAgICAgIHRoaXMuZHJhZ1N0YXJ0U3ViamVjdC5uZXh0KHsgaXRlbSwgZXZlbnQgfSk7XG4gICAgfVxuXG4gICAgZHJhZ0l0ZW1TdG9wKGl0ZW06IEdyaWRzdGVySXRlbVByb3RvdHlwZURpcmVjdGl2ZSwgZXZlbnQ6IERyYWdnYWJsZUV2ZW50KSB7XG4gICAgICAgIHRoaXMuaXNEcmFnZ2luZyA9IGZhbHNlO1xuICAgICAgICB0aGlzLmRyYWdTdG9wU3ViamVjdC5uZXh0KHsgaXRlbSwgZXZlbnQgfSk7XG4gICAgfVxuXG4gICAgdXBkYXRlUHJvdG90eXBlUG9zaXRpb24oaXRlbTogR3JpZHN0ZXJJdGVtUHJvdG90eXBlRGlyZWN0aXZlLCBldmVudDogRHJhZ2dhYmxlRXZlbnQpIHtcbiAgICAgICAgdGhpcy5kcmFnU3ViamVjdC5uZXh0KHsgaXRlbSwgZXZlbnQgfSk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogQ3JlYXRlcyBvYnNlcnZhYmxlIHRoYXQgaXMgZmlyZWQgb24gZHJhZ2dpbmcgb3ZlciBncmlkc3RlciBjb250YWluZXIuXG4gICAgICovXG4gICAgcHJpdmF0ZSBjcmVhdGVEcmFnT3Zlck9ic2VydmFibGUgKFxuICAgICAgICBkcmFnSXNPdmVyOiBPYnNlcnZhYmxlPHtpdGVtOiBHcmlkc3Rlckl0ZW1Qcm90b3R5cGVEaXJlY3RpdmUsIGlzT3ZlcjogYm9vbGVhbn0+LFxuICAgICAgICBncmlkc3RlcjogR3JpZHN0ZXJTZXJ2aWNlXG4gICAgKSB7XG4gICAgICAgIHJldHVybiBkcmFnSXNPdmVyLnBpcGUoXG4gICAgICAgICAgICBmaWx0ZXIoKGRhdGE6IGFueSkgPT4gZGF0YS5pc092ZXIgJiYgIWRhdGEuaXNFbnRlciAmJiAhZGF0YS5pc091dCksXG4gICAgICAgICAgICBtYXAoKGRhdGE6IGFueSk6IEdyaWRzdGVySXRlbVByb3RvdHlwZURpcmVjdGl2ZSA9PiBkYXRhLml0ZW0pLFxuICAgICAgICAgICAgdGFwKChpdGVtKSA9PiBpdGVtLm9uT3Zlcihncmlkc3RlcikpXG4gICAgICAgICk7XG4gICAgfVxuICAgIC8qKlxuICAgICAqIENyZWF0ZXMgb2JzZXJ2YWJsZSB0aGF0IGlzIGZpcmVkIG9uIGRyYWcgZW50ZXIgZ3JpZHN0ZXIgY29udGFpbmVyLlxuICAgICAqL1xuICAgIHByaXZhdGUgY3JlYXRlRHJhZ0VudGVyT2JzZXJ2YWJsZSAoXG4gICAgICAgIGRyYWdJc092ZXI6IE9ic2VydmFibGU8e2l0ZW06IEdyaWRzdGVySXRlbVByb3RvdHlwZURpcmVjdGl2ZSwgaXNPdmVyOiBib29sZWFufT4sXG4gICAgICAgIGdyaWRzdGVyOiBHcmlkc3RlclNlcnZpY2VcbiAgICApIHtcbiAgICAgICAgcmV0dXJuIGRyYWdJc092ZXIucGlwZShcbiAgICAgICAgICAgIGZpbHRlcigoZGF0YTogYW55KSA9PiBkYXRhLmlzRW50ZXIpLFxuICAgICAgICAgICAgbWFwKChkYXRhOiBhbnkpOiBHcmlkc3Rlckl0ZW1Qcm90b3R5cGVEaXJlY3RpdmUgPT4gZGF0YS5pdGVtKSxcbiAgICAgICAgICAgIHRhcCgoaXRlbSkgPT4gaXRlbS5vbkVudGVyKGdyaWRzdGVyKSlcbiAgICAgICAgKTtcbiAgICB9XG4gICAgLyoqXG4gICAgICogQ3JlYXRlcyBvYnNlcnZhYmxlIHRoYXQgaXMgZmlyZWQgb24gZHJhZyBvdXQgZ3JpZHN0ZXIgY29udGFpbmVyLlxuICAgICAqL1xuICAgIHByaXZhdGUgY3JlYXRlRHJhZ091dE9ic2VydmFibGUgKFxuICAgICAgICBkcmFnSXNPdmVyOiBPYnNlcnZhYmxlPHtpdGVtOiBHcmlkc3Rlckl0ZW1Qcm90b3R5cGVEaXJlY3RpdmUsXG4gICAgICAgIGlzT3ZlcjogYm9vbGVhbn0+LFxuICAgICAgICBncmlkc3RlcjogR3JpZHN0ZXJTZXJ2aWNlXG4gICAgKSB7XG4gICAgICAgIHJldHVybiBkcmFnSXNPdmVyLnBpcGUoXG4gICAgICAgICAgICBmaWx0ZXIoKGRhdGE6IGFueSkgPT4gZGF0YS5pc091dCksXG4gICAgICAgICAgICBtYXAoKGRhdGE6IGFueSk6IEdyaWRzdGVySXRlbVByb3RvdHlwZURpcmVjdGl2ZSA9PiBkYXRhLml0ZW0pLFxuICAgICAgICAgICAgdGFwKChpdGVtKSA9PiBpdGVtLm9uT3V0KGdyaWRzdGVyKSlcbiAgICAgICAgKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBDaGVja3Mgd2hldGhlciBcImVsZW1lbnRcIiBwb3NpdGlvbiBmaXRzIGluc2lkZSBcImNvbnRhaW5lckVsXCIgcG9zaXRpb24uXG4gICAgICogSXQgY2hlY2tzIGlmIFwiZWxlbWVudFwiIGlzIHRvdGFsbHkgY292ZXJlZCBieSBcImNvbnRhaW5lckVsXCIgYXJlYS5cbiAgICAgKi9cbiAgICBwcml2YXRlIGlzT3ZlckdyaWRzdGVyKGl0ZW06IEdyaWRzdGVySXRlbVByb3RvdHlwZURpcmVjdGl2ZSwgZ3JpZHN0ZXJFbDogSFRNTEVsZW1lbnQsIGV2ZW50LCBvcHRpb25zKTogYm9vbGVhbiB7XG4gICAgICAgIGNvbnN0IGVsID0gaXRlbS4kZWxlbWVudDtcbiAgICAgICAgY29uc3QgcGFyZW50SXRlbSA9IDxIVE1MRWxlbWVudD5ncmlkc3RlckVsLnBhcmVudEVsZW1lbnQgJiZcbiAgICAgICAgICAgIDxIVE1MRWxlbWVudD5ncmlkc3RlckVsLnBhcmVudEVsZW1lbnQuY2xvc2VzdCgnZ3JpZHN0ZXItaXRlbScpO1xuXG4gICAgICAgIGlmIChwYXJlbnRJdGVtKSB7XG4gICAgICAgICAgICByZXR1cm4gdGhpcy5pc092ZXJHcmlkc3RlcihpdGVtLCBwYXJlbnRJdGVtLCBldmVudCwgb3B0aW9ucyk7XG4gICAgICAgIH1cblxuICAgICAgICBzd2l0Y2ggKG9wdGlvbnMudG9sZXJhbmNlKSB7XG4gICAgICAgICAgICBjYXNlICdmaXQnOlxuICAgICAgICAgICAgICAgIHJldHVybiB1dGlscy5pc0VsZW1lbnRGaXRDb250YWluZXIoZWwsIGdyaWRzdGVyRWwpO1xuICAgICAgICAgICAgY2FzZSAnaW50ZXJzZWN0JzpcbiAgICAgICAgICAgICAgICByZXR1cm4gdXRpbHMuaXNFbGVtZW50SW50ZXJzZWN0Q29udGFpbmVyKGVsLCBncmlkc3RlckVsKTtcbiAgICAgICAgICAgIGNhc2UgJ3RvdWNoJzpcbiAgICAgICAgICAgICAgICByZXR1cm4gdXRpbHMuaXNFbGVtZW50VG91Y2hDb250YWluZXIoZWwsIGdyaWRzdGVyRWwpO1xuICAgICAgICAgICAgZGVmYXVsdDpcbiAgICAgICAgICAgICAgICByZXR1cm4gdXRpbHMuaXNDdXJzb3JBYm92ZUVsZW1lbnQoZXZlbnQsIGdyaWRzdGVyRWwpO1xuICAgICAgICB9XG4gICAgfVxufVxuIl19